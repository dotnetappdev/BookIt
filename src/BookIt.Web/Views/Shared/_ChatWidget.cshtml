@{
    // Extract tenantSlug from path: /{slug}/... or fallback to empty
    var path = Context.Request.Path.Value ?? "";
    var pathParts = path.Trim('/').Split('/');
    var chatTenantSlug = pathParts.Length >= 1 && !string.IsNullOrEmpty(pathParts[0]) ? pathParts[0] : "";
    // Only show widget on booking/tenant pages (not home, not admin)
    var showWidget = pathParts.Length >= 2 && (path.Contains("/book") || path.Contains("/booking"));
    if (!showWidget) { return; }
    
    var apiBase = $"/api/tenants/{chatTenantSlug}/chat";
    var vapiKey = ViewBag.VapiPublicKey as string ?? "";
}

<style>
/* Chat widget */
.chat-bubble {
    position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050;
    width: 60px; height: 60px; border-radius: 50%;
    background: var(--primary, #6c5ce7); color: white;
    border: none; box-shadow: 0 4px 20px rgba(0,0,0,.25);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: transform .2s, box-shadow .2s;
    font-size: 1.4rem;
}
.chat-bubble:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(0,0,0,.3); }
.chat-bubble .chat-bubble-badge {
    position: absolute; top: 0; right: 0; width: 14px; height: 14px;
    background: #22c55e; border-radius: 50%; border: 2px solid white;
}
.chat-panel {
    position: fixed; bottom: 5.5rem; right: 1.5rem; z-index: 1049;
    width: 360px; max-width: calc(100vw - 2rem);
    height: 520px; max-height: calc(100vh - 8rem);
    background: white; border-radius: 20px;
    box-shadow: 0 8px 40px rgba(0,0,0,.18);
    display: flex; flex-direction: column;
    transform: scale(.85) translateY(20px); opacity: 0;
    transform-origin: bottom right;
    transition: transform .25s cubic-bezier(.34,1.56,.64,1), opacity .2s;
    pointer-events: none;
}
.chat-panel.open { transform: scale(1) translateY(0); opacity: 1; pointer-events: all; }
.chat-header {
    padding: 1rem 1.25rem; border-bottom: 1px solid #f1f5f9;
    border-radius: 20px 20px 0 0;
    background: var(--primary, #6c5ce7); color: white;
    display: flex; align-items: center; gap: .75rem;
}
.chat-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,.25); display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; flex-shrink: 0;
}
.chat-status { display: flex; align-items: center; gap: .4rem; font-size: .75rem; opacity: .85; }
.chat-status::before { content: ''; width: 7px; height: 7px; border-radius: 50%; background: #4ade80; }
.chat-messages {
    flex: 1; overflow-y: auto; padding: 1rem;
    display: flex; flex-direction: column; gap: .75rem;
    scroll-behavior: smooth;
}
.chat-msg {
    max-width: 85%; line-height: 1.5; font-size: .875rem;
    padding: .6rem .9rem; border-radius: 14px; word-break: break-word;
    white-space: pre-wrap;
}
.chat-msg.user {
    align-self: flex-end; background: var(--primary, #6c5ce7); color: white;
    border-bottom-right-radius: 4px;
}
.chat-msg.bot {
    align-self: flex-start; background: #f1f5f9; color: #1e293b;
    border-bottom-left-radius: 4px;
}
.chat-msg.bot strong { color: var(--primary, #6c5ce7); }
.chat-typing {
    align-self: flex-start; background: #f1f5f9; color: #94a3b8;
    padding: .6rem 1rem; border-radius: 14px 14px 14px 4px;
    font-size: .8rem; display: none;
}
.chat-typing.show { display: block; }
.chat-typing span { animation: chatDots 1.2s infinite; }
.chat-typing span:nth-child(2) { animation-delay: .2s; }
.chat-typing span:nth-child(3) { animation-delay: .4s; }
@@keyframes chatDots { 0%,80%,100% { opacity: .2; } 40% { opacity: 1; } }
.quick-replies { display: flex; flex-wrap: wrap; gap: .4rem; margin-top: .25rem; max-width: 100%; }
.quick-reply-btn {
    font-size: .8rem; padding: .3rem .7rem; border-radius: 99px;
    border: 1.5px solid var(--primary, #6c5ce7); background: white;
    color: var(--primary, #6c5ce7); cursor: pointer; transition: all .15s;
    white-space: nowrap;
}
.quick-reply-btn:hover { background: var(--primary, #6c5ce7); color: white; }
.chat-input-row {
    padding: .75rem 1rem; border-top: 1px solid #f1f5f9;
    display: flex; gap: .5rem; align-items: flex-end;
    border-radius: 0 0 20px 20px;
    background: white;
}
.chat-input {
    flex: 1; border: 1.5px solid #e2e8f0; border-radius: 10px; 
    padding: .5rem .75rem; font-size: .875rem; resize: none;
    outline: none; font-family: inherit; line-height: 1.5;
    max-height: 100px; overflow-y: auto;
    transition: border-color .15s;
}
.chat-input:focus { border-color: var(--primary, #6c5ce7); }
.chat-icon-btn {
    width: 38px; height: 38px; border-radius: 50%; border: none;
    background: var(--primary, #6c5ce7); color: white;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0; transition: opacity .15s;
    font-size: 1rem;
}
.chat-icon-btn:hover { opacity: .85; }
.chat-icon-btn.secondary { background: #f1f5f9; color: #475569; }
.chat-icon-btn.secondary:hover { background: #e2e8f0; }
.chat-icon-btn.recording { background: #ef4444 !important; animation: pulse .8s infinite; }
@@keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,.4); } 50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); } }

/* Vapi voice button */
.vapi-btn {
    position: fixed; bottom: 1.5rem; right: 5.5rem; z-index: 1048;
    width: 50px; height: 50px; border-radius: 50%;
    background: #16213e; color: white; border: none;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.2rem;
    box-shadow: 0 4px 16px rgba(0,0,0,.2);
    transition: transform .2s;
    display: none;
}
.vapi-btn.visible { display: flex; }
.vapi-btn:hover { transform: scale(1.1); }
.vapi-btn.active { background: #ef4444; animation: pulse .8s infinite; }
.vapi-label {
    position: fixed; bottom: 5rem; right: 5.5rem; z-index: 1048;
    background: #1e293b; color: white; font-size: .7rem; font-weight: 600;
    padding: .2rem .5rem; border-radius: 6px; letter-spacing: .05em;
    display: none; white-space: nowrap;
}
.vapi-btn.visible ~ .vapi-label { display: block; }

@@media (max-width: 479.98px) {
    .chat-panel { width: calc(100vw - 1.5rem); right: .75rem; bottom: 5rem; }
    .chat-bubble { bottom: 1rem; right: 1rem; width: 54px; height: 54px; }
    .vapi-btn { right: 4.75rem; bottom: 1rem; width: 44px; height: 44px; }
}
</style>

<!-- Vapi voice AI button (shown if key configured) -->
<button class="vapi-btn" id="vapiBtn" aria-label="AI Voice Booking" title="Talk to AI booking assistant">
    <i class="bi bi-mic-fill"></i>
</button>
<div class="vapi-label" id="vapiLabel">AI Voice</div>

<!-- Chat bubble -->
<button class="chat-bubble" id="chatBubble" onclick="toggleChat()" aria-label="Open booking chat assistant" title="Chat with AI booking assistant">
    <i class="bi bi-chat-dots-fill" id="chatBubbleIcon"></i>
    <div class="chat-bubble-badge" aria-hidden="true"></div>
</button>

<!-- Chat panel -->
<div class="chat-panel" id="chatPanel" role="dialog" aria-label="Booking chat assistant" aria-modal="true">
    <div class="chat-header">
        <div class="chat-avatar"><i class="bi bi-robot"></i></div>
        <div class="flex-grow-1">
            <div style="font-weight:600;font-size:.9rem;">BookIt Assistant</div>
            <div class="chat-status">Online ¬∑ Ready to help</div>
        </div>
        <button onclick="toggleChat()" style="background:none;border:none;color:white;opacity:.8;font-size:1.1rem;" aria-label="Close chat">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="chat-msg bot">üëã Hi! I'm your booking assistant. I can help you <strong>book an appointment</strong>, check our <strong>services &amp; prices</strong>, or look up an <strong>existing booking</strong> using your PIN.</div>
        <div class="quick-replies" id="initQuickReplies">
            <button class="quick-reply-btn" onclick="sendQuick('Book an appointment')">Book an appointment</button>
            <button class="quick-reply-btn" onclick="sendQuick('What services are available?')">Services &amp; prices</button>
            <button class="quick-reply-btn" onclick="sendQuick('Look up booking with PIN')">Look up my booking</button>
        </div>
        <div class="chat-typing" id="chatTyping"><span>‚óè</span><span>‚óè</span><span>‚óè</span></div>
    </div>
    <div class="chat-input-row">
        <button class="chat-icon-btn secondary" id="micBtn" onclick="toggleMic()" title="Voice input" aria-label="Start voice input">
            <i class="bi bi-mic" id="micIcon"></i>
        </button>
        <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"
                  onkeydown="handleKey(event)" oninput="autoResize(this)"
                  aria-label="Chat message"></textarea>
        <button class="chat-icon-btn" onclick="sendMessage()" title="Send message" aria-label="Send">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

<script>
(function() {
    const TENANT_SLUG = '@chatTenantSlug';
    const API_URL = '@apiBase';
    const VAPI_KEY = '@vapiKey';
    let chatOpen = false;
    let history = [];
    let sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).slice(2);
    let recognition = null;
    let isRecording = false;
    let vapiInstance = null;
    let vapiActive = false;
    let currentElevenLabsKey = '';
    let currentElevenLabsVoice = '';

    // ‚îÄ‚îÄ Toggle chat ‚îÄ‚îÄ
    window.toggleChat = function() {
        chatOpen = !chatOpen;
        document.getElementById('chatPanel').classList.toggle('open', chatOpen);
        document.getElementById('chatBubbleIcon').className = chatOpen ? 'bi bi-x-lg' : 'bi bi-chat-dots-fill';
        if (chatOpen) setTimeout(() => document.getElementById('chatInput').focus(), 300);
    };

    // ‚îÄ‚îÄ Send message ‚îÄ‚îÄ
    window.sendMessage = async function() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        input.style.height = '';
        appendMsg('user', text);
        history.push({ role: 'user', content: text });
        showTyping(true);

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, sessionId, history: history.slice(-10) })
            });
            const data = await res.json();
            showTyping(false);
            appendMsg('bot', data.message, data.quickReplies);
            history.push({ role: 'assistant', content: data.message });

            // Cache ElevenLabs keys from response
            if (data.elevenLabsApiKey) currentElevenLabsKey = data.elevenLabsApiKey;
            if (data.elevenLabsVoiceId) currentElevenLabsVoice = data.elevenLabsVoiceId;

            // Speak response
            if (data.useElevenLabs && data.elevenLabsApiKey) {
                speakElevenLabs(data.message.replace(/\*\*/g, '').replace(/\n/g, ' '), data.elevenLabsApiKey, data.elevenLabsVoiceId || '21m00Tcm4TlvDq8ikWAM');
            } else {
                speakBrowser(data.message.replace(/\*\*/g, '').replace(/\n/g, ' '));
            }

            // Handle redirect action
            if (data.action?.type === 'redirect' && data.action.url) {
                setTimeout(() => { if (confirm('Go to booking page now?')) window.location.href = data.action.url; }, 800);
            }
        } catch(e) {
            showTyping(false);
            appendMsg('bot', 'Sorry, something went wrong. Please try again.', ['Retry', 'Help']);
        }
    };

    window.sendQuick = function(text) {
        document.getElementById('chatInput').value = text;
        sendMessage();
    };

    window.handleKey = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    };

    window.autoResize = function(el) {
        el.style.height = '';
        el.style.height = Math.min(el.scrollHeight, 100) + 'px';
    };

    function appendMsg(role, text, quickReplies) {
        const msgs = document.getElementById('chatMessages');
        const typing = document.getElementById('chatTyping');
        
        const div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        div.innerHTML = formatMsg(text);
        msgs.insertBefore(div, typing);

        if (quickReplies && quickReplies.length) {
            const qr = document.createElement('div');
            qr.className = 'quick-replies';
            quickReplies.forEach(r => {
                const btn = document.createElement('button');
                btn.className = 'quick-reply-btn';
                btn.textContent = r;
                btn.onclick = () => sendQuick(r);
                qr.appendChild(btn);
            });
            msgs.insertBefore(qr, typing);
        }
        msgs.scrollTop = msgs.scrollHeight;
    }

    function formatMsg(text) {
        return text
            .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
            .replace(/\n/g,'<br>');
    }

    function showTyping(show) {
        document.getElementById('chatTyping').classList.toggle('show', show);
        document.getElementById('chatMessages').scrollTop = 999999;
    }

    // ‚îÄ‚îÄ Web Speech API (voice input) ‚îÄ‚îÄ
    window.toggleMic = function() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert('Voice input is not supported in this browser. Try Chrome or Edge.');
            return;
        }
        if (isRecording) {
            recognition?.stop();
            return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-GB';
        recognition.interimResults = true;
        recognition.continuous = false;
        isRecording = true;
        document.getElementById('micBtn').classList.add('recording');
        document.getElementById('micIcon').className = 'bi bi-stop-fill';
        recognition.onresult = e => {
            const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
            document.getElementById('chatInput').value = transcript;
        };
        recognition.onend = () => {
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            document.getElementById('micIcon').className = 'bi bi-mic';
            const val = document.getElementById('chatInput').value.trim();
            if (val) sendMessage();
        };
        recognition.onerror = e => {
            console.warn('Speech recognition error:', e.error);
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            document.getElementById('micIcon').className = 'bi bi-mic';
        };
        recognition.start();
    };

    // ‚îÄ‚îÄ Browser TTS (fallback) ‚îÄ‚îÄ
    function speakBrowser(text) {
        if (!('speechSynthesis' in window) || !text) return;
        window.speechSynthesis.cancel();
        const utt = new SpeechSynthesisUtterance(text.slice(0, 300));
        utt.lang = 'en-GB';
        utt.rate = 1.05;
        const voices = speechSynthesis.getVoices();
        const preferred = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'))
            || voices.find(v => v.lang.startsWith('en'))
            || voices[0];
        if (preferred) utt.voice = preferred;
        window.speechSynthesis.speak(utt);
    }

    // ‚îÄ‚îÄ ElevenLabs TTS ‚îÄ‚îÄ
    async function speakElevenLabs(text, apiKey, voiceId) {
        try {
            const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`, {
                method: 'POST',
                headers: { 'xi-api-key': apiKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text.slice(0, 400), model_id: 'eleven_multilingual_v2', voice_settings: { stability: 0.5, similarity_boost: 0.75 } })
            });
            if (!res.ok) { speakBrowser(text); return; }
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.onended = () => URL.revokeObjectURL(url);
            audio.play();
        } catch(e) {
            speakBrowser(text);
        }
    }

    // ‚îÄ‚îÄ Vapi.ai voice AI ‚îÄ‚îÄ
    function initVapi() {
        if (!VAPI_KEY) return;
        const btn = document.getElementById('vapiBtn');
        btn.classList.add('visible');
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@@vapi-ai/web@@latest/dist/vapi.umd.js';
        script.onload = () => {
            try {
                vapiInstance = new window.Vapi(VAPI_KEY);
                
                vapiInstance.on('call-start', () => {
                    vapiActive = true;
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="bi bi-stop-fill"></i>';
                    btn.title = 'End AI voice call';
                });
                vapiInstance.on('call-end', () => {
                    vapiActive = false;
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="bi bi-mic-fill"></i>';
                    btn.title = 'Talk to AI booking assistant';
                });
            } catch(e) {
                console.warn('Vapi init failed:', e);
            }
        };
        document.head.appendChild(script);

        btn.onclick = function() {
            if (!vapiInstance) return;
            if (vapiActive) {
                vapiInstance.stop();
            } else {
                vapiInstance.start({
                    transcriber: { provider: 'deepgram', model: 'nova-2', language: 'en-GB' },
                    model: {
                        provider: 'openai',
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'system',
                            content: `You are a friendly AI booking assistant for a business using BookIt. Help customers book appointments by asking them what service they need, then tell them to visit the booking page at /${TENANT_SLUG}/book. If they want to look up a booking, ask for their 6-character PIN. Be concise and helpful. Keep responses under 2 sentences.`
                        }]
                    },
                    voice: { provider: 'elevenlabs', voiceId: '21m00Tcm4TlvDq8ikWAM' },
                    name: 'BookIt Assistant'
                });
            }
        };
    }

    // Check Web Speech support and show mic conditionally
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        document.getElementById('micBtn').style.display = 'none';
    }

    initVapi();
})();
</script>
