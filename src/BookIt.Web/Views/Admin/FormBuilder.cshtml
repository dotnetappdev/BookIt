@using BookIt.Core.DTOs
@using System.Text.Json
@{
    ViewData["Title"] = "Form Builder";
    Layout = "_AdminLayout";
    var tenantSlug = ViewBag.TenantSlug as string ?? "";
    var form = ViewBag.Form as BookingFormResponse;
    var formId = ViewBag.FormId as Guid?;
    var accessToken = ViewBag.AccessToken as string ?? "";
    var fieldsJson = form != null ? JsonSerializer.Serialize(form.Fields) : "[]";
}

@section Styles {
<style>
.builder-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 1.5rem;
    align-items: start;
}
@@media (max-width: 991.98px) {
    .builder-layout { grid-template-columns: 1fr; }
    .toolbox-panel { order: -1; }
}
.toolbox-panel {
    position: sticky;
    top: calc(var(--topbar-height) + 1rem);
}
.toolbox-item {
    display: flex;
    align-items: center;
    gap: .6rem;
    padding: .6rem .9rem;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border);
    background: var(--surface);
    cursor: pointer;
    font-size: .875rem;
    font-weight: 500;
    color: var(--text);
    transition: var(--transition);
    width: 100%;
    text-align: left;
}
.toolbox-item:hover { border-color: var(--primary-light); background: var(--primary-subtle); color: var(--primary); }
.toolbox-item i { font-size: 1rem; color: var(--primary); width: 18px; flex-shrink: 0; }
.field-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    margin-bottom: .75rem;
    transition: var(--transition);
    position: relative;
}
.field-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow-sm); }
.field-card.dragging { opacity: .5; border-style: dashed; }
.field-card.drag-over { border-color: var(--primary); background: var(--primary-subtle); }
.field-handle { cursor: grab; color: var(--text-muted); padding: .25rem; margin-right: .5rem; }
.field-handle:active { cursor: grabbing; }
.field-type-badge {
    font-size: .7rem; font-weight: 600;
    padding: .2rem .55rem;
    border-radius: 99px;
    background: var(--primary-subtle);
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: .05em;
}
.empty-canvas {
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 3rem 2rem;
    text-align: center;
    color: var(--text-muted);
}
.edit-panel {
    display: none;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    padding: 1rem;
    margin-top: .75rem;
    border: 1px solid var(--border);
}
.edit-panel.show { display: block; }
</style>
}

<div class="page-header">
    <div>
        <h1 class="page-title">@(form?.Name ?? "Form Builder")</h1>
        <p class="page-subtitle">
            <a asp-controller="Admin" asp-action="Forms" asp-route-tenantSlug="@tenantSlug" class="text-muted text-decoration-none"><i class="bi bi-arrow-left me-1"></i>Back to Forms</a>
        </p>
    </div>
    @if (form?.IsDefault == true)
    {
        <span class="badge py-2 px-3" style="background:var(--primary-subtle);color:var(--primary);font-size:.8rem;">
            <i class="bi bi-star-fill me-1"></i>Default Form
        </span>
    }
</div>

@if (formId == null)
{
    <div class="alert alert-warning">No form selected. <a asp-controller="Admin" asp-action="Forms" asp-route-tenantSlug="@tenantSlug">Go back to Forms</a></div>
}
else
{
    <div class="builder-layout">
        <!-- Canvas -->
        <div>
            <div class="card">
                <div class="card-header px-4 py-3 d-flex align-items-center justify-content-between">
                    <span class="fw-semibold"><i class="bi bi-layout-text-sidebar me-2 text-brand"></i>Form Fields</span>
                    <span class="small text-muted" id="fieldCount">0 fields</span>
                </div>
                <div class="card-body p-4">
                    <div id="fieldCanvas"></div>
                    <div id="emptyCanvas" class="empty-canvas" style="display:none;">
                        <i class="bi bi-ui-checks-grid fs-1 d-block mb-3 opacity-25"></i>
                        <p class="fw-medium mb-1">No fields yet</p>
                        <p class="small">Click a field type in the toolbox on the right to add it</p>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="card mt-4">
                <div class="card-header px-4 py-3 d-flex align-items-center gap-2">
                    <i class="bi bi-eye text-brand"></i>
                    <span class="fw-semibold">Live Preview</span>
                    <span class="small text-muted ms-1">(how customers will see it)</span>
                </div>
                <div class="card-body p-4" id="previewCanvas">
                    <p class="text-muted small">Add fields to see the preview</p>
                </div>
            </div>
        </div>

        <!-- Toolbox (sticky) -->
        <div class="toolbox-panel">
            <div class="card">
                <div class="card-header px-3 py-3">
                    <span class="fw-semibold" style="font-size:.9rem;"><i class="bi bi-tools me-2 text-brand"></i>Field Types</span>
                </div>
                <div class="card-body p-3 d-flex flex-column gap-2">
                    <button class="toolbox-item" onclick="addField('Text')">
                        <i class="bi bi-cursor-text"></i>Short Text
                    </button>
                    <button class="toolbox-item" onclick="addField('TextArea')">
                        <i class="bi bi-textarea-t"></i>Long Text
                    </button>
                    <button class="toolbox-item" onclick="addField('Email')">
                        <i class="bi bi-envelope"></i>Email
                    </button>
                    <button class="toolbox-item" onclick="addField('Phone')">
                        <i class="bi bi-telephone"></i>Phone
                    </button>
                    <button class="toolbox-item" onclick="addField('Number')">
                        <i class="bi bi-hash"></i>Number
                    </button>
                    <button class="toolbox-item" onclick="addField('Date')">
                        <i class="bi bi-calendar3"></i>Date
                    </button>
                    <hr class="my-1" />
                    <button class="toolbox-item" onclick="addField('Select')">
                        <i class="bi bi-menu-button"></i>Dropdown
                    </button>
                    <button class="toolbox-item" onclick="addField('Radio')">
                        <i class="bi bi-record-circle"></i>Radio Buttons
                    </button>
                    <button class="toolbox-item" onclick="addField('Checkbox')">
                        <i class="bi bi-check2-square"></i>Checkboxes
                    </button>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body p-3">
                    <p class="small text-muted mb-2"><i class="bi bi-info-circle me-1"></i>Tips</p>
                    <ul class="list-unstyled small text-muted mb-0" style="line-height:1.8;">
                        <li>Drag fields to reorder</li>
                        <li>Click ✏ to edit labels</li>
                        <li>Use options for dropdowns, radios, checkboxes (one per line)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
const TENANT_SLUG = '@tenantSlug';
const FORM_ID = '@formId';
const ACCESS_TOKEN = '@accessToken';
const API_BASE = '/api/tenants/' + TENANT_SLUG + '/booking-forms/' + FORM_ID;

let fields = @Html.Raw(fieldsJson);
let dragSrcIdx = null;

function authHeaders() {
    return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + ACCESS_TOKEN
    };
}

const FIELD_TYPE_LABELS = {
    Text: 'Short Text', TextArea: 'Long Text', Email: 'Email', Phone: 'Phone',
    Number: 'Number', Date: 'Date', Select: 'Dropdown', Radio: 'Radio Buttons', Checkbox: 'Checkboxes'
};
const FIELD_TYPE_ICONS = {
    Text: 'cursor-text', TextArea: 'textarea-t', Email: 'envelope', Phone: 'telephone',
    Number: 'hash', Date: 'calendar3', Select: 'menu-button', Radio: 'record-circle', Checkbox: 'check2-square'
};

function renderCanvas() {
    const canvas = document.getElementById('fieldCanvas');
    const empty = document.getElementById('emptyCanvas');
    document.getElementById('fieldCount').textContent = fields.length + ' field' + (fields.length !== 1 ? 's' : '');
    if (fields.length === 0) {
        canvas.innerHTML = '';
        empty.style.display = 'block';
        document.getElementById('previewCanvas').innerHTML = '<p class="text-muted small">Add fields to see the preview</p>';
        return;
    }
    empty.style.display = 'none';
    canvas.innerHTML = fields.map((f, i) => buildFieldCard(f, i)).join('');
    renderPreview();
    canvas.querySelectorAll('.field-card').forEach((card, i) => {
        card.addEventListener('dragstart', e => { dragSrcIdx = i; card.classList.add('dragging'); });
        card.addEventListener('dragend', () => card.classList.remove('dragging'));
        card.addEventListener('dragover', e => { e.preventDefault(); card.classList.add('drag-over'); });
        card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
        card.addEventListener('drop', e => { e.preventDefault(); card.classList.remove('drag-over'); dropField(i); });
    });
}

function buildFieldCard(f, i) {
    const typeLabel = FIELD_TYPE_LABELS[f.fieldType] || f.fieldType;
    const icon = FIELD_TYPE_ICONS[f.fieldType] || 'question';
    const hasOptions = ['Select','Radio','Checkbox'].includes(f.fieldType);
    const opts = f.optionsJson ? JSON.parse(f.optionsJson) : [];
    return `<div class="field-card" draggable="true" data-idx="${i}">
        <div class="d-flex align-items-center gap-2 mb-2">
            <span class="field-handle" title="Drag to reorder"><i class="bi bi-grip-vertical"></i></span>
            <i class="bi bi-${icon} text-brand"></i>
            <span class="fw-semibold flex-grow-1" style="font-size:.9rem;">${escHtml(f.label)}</span>
            ${f.isRequired ? '<span class="badge bg-danger" style="font-size:.65rem;">Required</span>' : ''}
            <span class="field-type-badge">${typeLabel}</span>
            <button class="btn btn-sm btn-link p-1 text-muted" onclick="toggleEdit(${i})" title="Edit field" aria-label="Edit ${escHtml(f.label)}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-link p-1 text-danger" onclick="deleteField('${f.id}',${i})" title="Delete" aria-label="Delete field"><i class="bi bi-trash"></i></button>
        </div>
        <div class="edit-panel" id="edit-${i}">
            <div class="row g-2 mb-2">
                <div class="col-sm-8">
                    <label class="form-label small mb-1">Label</label>
                    <input type="text" class="form-control form-control-sm" value="${escHtml(f.label)}" onchange="updateFieldLocal(${i},'label',this.value)" />
                </div>
                <div class="col-sm-4">
                    <label class="form-label small mb-1">Required</label>
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" ${f.isRequired ? 'checked' : ''} onchange="updateFieldLocal(${i},'isRequired',this.checked)" />
                        <label class="form-check-label small">Yes</label>
                    </div>
                </div>
                <div class="col-12">
                    <label class="form-label small mb-1">Placeholder</label>
                    <input type="text" class="form-control form-control-sm" value="${escHtml(f.placeholder||'')}" onchange="updateFieldLocal(${i},'placeholder',this.value)" />
                </div>
                ${hasOptions ? `<div class="col-12">
                    <label class="form-label small mb-1">Options <span class="text-muted">(one per line)</span></label>
                    <textarea class="form-control form-control-sm" rows="3" onchange="updateFieldOptions(${i},this.value)">${opts.join('\n')}</textarea>
                </div>` : ''}
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-brand" onclick="saveField(${i})"><i class="bi bi-check2 me-1"></i>Save</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleEdit(${i})">Cancel</button>
            </div>
        </div>
    </div>`;
}

function renderPreview() {
    const preview = document.getElementById('previewCanvas');
    if (fields.length === 0) { preview.innerHTML = '<p class="text-muted small">Add fields to see the preview</p>'; return; }
    preview.innerHTML = fields.map(f => buildPreviewField(f)).join('');
}

function buildPreviewField(f) {
    const req = f.isRequired ? '<span class="text-danger ms-1">*</span>' : '';
    const opts = f.optionsJson ? JSON.parse(f.optionsJson) : [];
    let input = '';
    switch(f.fieldType) {
        case 'Text': case 'Email': case 'Phone': case 'Number':
            const t = {Text:'text',Email:'email',Phone:'tel',Number:'number'}[f.fieldType];
            input = `<input type="${t}" class="form-control form-control-sm" placeholder="${escHtml(f.placeholder||'')}" disabled />`;
            break;
        case 'TextArea':
            input = `<textarea class="form-control form-control-sm" rows="3" placeholder="${escHtml(f.placeholder||'')}" disabled></textarea>`;
            break;
        case 'Date':
            input = `<input type="date" class="form-control form-control-sm" disabled />`;
            break;
        case 'Select':
            input = `<select class="form-select form-select-sm" disabled><option>${f.placeholder||'— Select —'}</option>${opts.map(o=>`<option>${escHtml(o)}</option>`).join('')}</select>`;
            break;
        case 'Radio':
            input = `<div class="d-flex flex-wrap gap-3">${opts.map(o=>`<div class="form-check"><input class="form-check-input" type="radio" disabled /><label class="form-check-label small">${escHtml(o)}</label></div>`).join('')}</div>`;
            break;
        case 'Checkbox':
            if (opts.length) {
                input = `<div class="d-flex flex-wrap gap-3">${opts.map(o=>`<div class="form-check"><input class="form-check-input" type="checkbox" disabled /><label class="form-check-label small">${escHtml(o)}</label></div>`).join('')}</div>`;
            } else {
                input = `<div class="form-check"><input class="form-check-input" type="checkbox" disabled /><label class="form-check-label small">Yes</label></div>`;
            }
            break;
    }
    return `<div class="mb-3"><label class="form-label fw-semibold" style="font-size:.875rem;">${escHtml(f.label)}${req}</label>${input}</div>`;
}

function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toggleEdit(i) {
    const panel = document.getElementById('edit-'+i);
    panel?.classList.toggle('show');
}

function updateFieldLocal(i, key, val) {
    fields[i][key] = val;
    renderPreview();
}

function updateFieldOptions(i, text) {
    const opts = text.split('\n').map(o=>o.trim()).filter(Boolean);
    fields[i].optionsJson = JSON.stringify(opts);
    renderPreview();
}

async function saveField(i) {
    const f = fields[i];
    const body = { label: f.label, fieldType: fieldTypeToInt(f.fieldType), isRequired: f.isRequired, placeholder: f.placeholder, optionsJson: f.optionsJson };
    const res = await fetch(API_BASE + '/fields/' + f.id, { method: 'PUT', headers: authHeaders(), body: JSON.stringify(body) });
    if (res.ok) {
        const updated = await res.json();
        fields[i] = { ...fields[i], ...updated, fieldType: intToFieldType(updated.fieldType) };
        showToast('Field saved');
        renderCanvas();
    } else {
        showToast('Failed to save field', true);
    }
}

async function addField(typeName) {
    const labelMap = { Text:'New Text Field', TextArea:'New Paragraph', Email:'Email Address', Phone:'Phone Number', Number:'Number', Date:'Date', Select:'Dropdown', Radio:'Radio Choice', Checkbox:'Checkbox' };
    const body = { label: labelMap[typeName]||'New Field', fieldType: fieldTypeToInt(typeName), isRequired: false, sortOrder: fields.length };
    const res = await fetch(API_BASE + '/fields', { method: 'POST', headers: authHeaders(), body: JSON.stringify(body) });
    if (res.ok) {
        const newField = await res.json();
        newField.fieldType = typeName;
        fields.push(newField);
        renderCanvas();
        showToast(typeName + ' field added');
        setTimeout(() => {
            const editPanel = document.getElementById('edit-'+(fields.length-1));
            if (editPanel) editPanel.classList.add('show');
        }, 50);
    } else {
        showToast('Failed to add field', true);
    }
}

async function deleteField(id, i) {
    if (!confirm('Delete this field?')) return;
    const res = await fetch(API_BASE + '/fields/' + id, { method: 'DELETE', headers: authHeaders() });
    if (res.ok) {
        fields.splice(i, 1);
        renderCanvas();
        showToast('Field deleted');
    } else {
        showToast('Failed to delete field', true);
    }
}

async function dropField(targetIdx) {
    if (dragSrcIdx === null || dragSrcIdx === targetIdx) return;
    const moved = fields.splice(dragSrcIdx, 1)[0];
    fields.splice(targetIdx, 0, moved);
    const ids = fields.map(f => f.id);
    await fetch(API_BASE + '/fields/reorder', { method: 'POST', headers: authHeaders(), body: JSON.stringify({ fieldIds: ids }) });
    renderCanvas();
    dragSrcIdx = null;
}

function fieldTypeToInt(name) {
    return { Text:1, Email:2, Phone:3, TextArea:4, Select:5, Checkbox:6, Date:7, Number:8, Radio:9 }[name] || 1;
}
function intToFieldType(n) {
    return ['','Text','Email','Phone','TextArea','Select','Checkbox','Date','Number','Radio'][n] || 'Text';
}

fields = fields.map(f => ({ ...f, fieldType: typeof f.fieldType === 'number' ? intToFieldType(f.fieldType) : f.fieldType }));

function showToast(msg, isError) {
    const t = document.createElement('div');
    t.className = 'position-fixed bottom-0 end-0 m-3 alert ' + (isError ? 'alert-danger' : 'alert-success') + ' shadow border-0 py-2 px-3';
    t.style.cssText = 'z-index:9999;font-size:.875rem;border-radius:8px;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

renderCanvas();
</script>
}
