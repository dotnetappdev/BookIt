@using BookIt.Core.DTOs
@{
    ViewData["Title"] = "Manage Staff";
    Layout = "_AdminLayout";
    var tenant = ViewBag.Tenant as TenantResponse;
    var staffList = ViewBag.Staff as List<StaffResponse> ?? new();
    var services = ViewBag.Services as List<ServiceResponse> ?? new();
    var tenantSlug = ViewBag.TenantSlug as string ?? "";
    var accessToken = ViewBag.AccessToken as string ?? "";
}

<div class="page-header">
    <div>
        <h1 class="page-title">Staff</h1>
        <p class="page-subtitle">Manage your team members and service assignments</p>
    </div>
    <button class="btn btn-brand" data-bs-toggle="modal" data-bs-target="#addStaffModal" aria-haspopup="dialog">
        <i class="bi bi-person-plus me-2"></i>Add Staff Member
    </button>
</div>

<div>
    @if (!staffList.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-people fs-1 text-muted d-block mb-3"></i>
            <h5 class="text-muted">No staff members yet</h5>
            <button class="btn btn-brand" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                <i class="bi bi-person-plus me-2"></i>Add Your First Staff Member
            </button>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var member in staffList)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-start gap-3">
                                @if (!string.IsNullOrEmpty(member.PhotoUrl))
                                {
                                    <img src="@member.PhotoUrl" alt="@member.FullName" class="rounded-circle" style="width:56px;height:56px;object-fit:cover;flex-shrink:0;" />
                                }
                                else
                                {
                                    <div class="rounded-circle bg-brand text-white d-flex align-items-center justify-content-center fw-bold fs-5" style="width:56px;height:56px;flex-shrink:0;">
                                        @(member.FirstName.Length > 0 ? member.FirstName[0].ToString() : "")@(member.LastName.Length > 0 ? member.LastName[0].ToString() : "")
                                    </div>
                                }
                                <div class="flex-grow-1 min-width-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="fw-bold mb-0">@member.FullName</h6>
                                            @if (!string.IsNullOrEmpty(member.Email))
                                            {
                                                <div class="text-muted small"><i class="bi bi-envelope me-1"></i>@member.Email</div>
                                            }
                                            @if (!string.IsNullOrEmpty(member.Phone))
                                            {
                                                <div class="text-muted small"><i class="bi bi-telephone me-1"></i>@member.Phone</div>
                                            }
                                        </div>
                                        <span class="badge @(member.IsActive ? "bg-success" : "bg-secondary") ms-2">
                                            @(member.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(member.Bio))
                                    {
                                        <p class="text-muted small mt-2 mb-2">@member.Bio</p>
                                    }
                                    @if (member.Services.Any())
                                    {
                                        <div class="mt-2 d-flex gap-1 flex-wrap">
                                            @foreach (var svc in member.Services)
                                            {
                                                <span class="badge bg-light text-dark border small">@svc.Name</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="text-muted small mt-2"><i class="bi bi-info-circle me-1"></i>No services assigned</div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pb-3 d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary flex-fill"
                                    data-staff-id="@member.Id"
                                    data-first-name="@member.FirstName"
                                    data-last-name="@member.LastName"
                                    data-email="@(member.Email ?? "")"
                                    data-phone="@(member.Phone ?? "")"
                                    data-photo-url="@(member.PhotoUrl ?? "")"
                                    data-bio="@(member.Bio ?? "")"
                                    data-is-active="@member.IsActive.ToString().ToLower()"
                                    data-sort-order="@member.SortOrder"
                                    onclick="openEditModal(this)"
                                    aria-label="Edit @member.FullName">
                                <i class="bi bi-pencil me-1"></i>Edit
                            </button>
                            <button class="btn btn-sm btn-outline-primary flex-fill"
                                    onclick="openServicesModal('@member.Id', '@member.FullName', [@string.Join(",", member.Services.Select(s => $"'{s.Id}'"))])"
                                    aria-label="Manage services for @member.FullName">
                                <i class="bi bi-grid me-1"></i>Services
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteStaff('@member.Id', '@member.FullName')"
                                    aria-label="Delete @member.FullName">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal" tabindex="-1" aria-labelledby="addStaffModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-brand text-white">
                <h5 class="modal-title" id="addStaffModalLabel"><i class="bi bi-person-plus me-2"></i>Add Staff Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addStaffForm">
                <div class="modal-body p-4">
                    <div class="admin-form-grid">
                        <div>
                            <label for="addFirstName" class="form-label fw-semibold">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addFirstName" name="firstName" required aria-required="true" />
                        </div>
                        <div>
                            <label for="addLastName" class="form-label fw-semibold">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addLastName" name="lastName" required aria-required="true" />
                        </div>
                        <div>
                            <label for="addEmail" class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control" id="addEmail" name="email" />
                        </div>
                        <div>
                            <label for="addPhone" class="form-label fw-semibold">Phone</label>
                            <input type="tel" class="form-control" id="addPhone" name="phone" />
                        </div>
                        <div class="afc-12">
                            <label for="addPhotoUrl" class="form-label fw-semibold">Photo URL</label>
                            <input type="url" class="form-control" id="addPhotoUrl" name="photoUrl" placeholder="https://..." />
                        </div>
                        <div class="afc-12">
                            <label for="addBio" class="form-label fw-semibold">Bio</label>
                            <textarea class="form-control" id="addBio" name="bio" rows="3" placeholder="Short bio or role description..."></textarea>
                        </div>
                        <div>
                            <label for="addSortOrder" class="form-label fw-semibold">Sort Order</label>
                            <input type="number" class="form-control" id="addSortOrder" name="sortOrder" value="0" min="0" />
                        </div>
                        <div class="admin-check-cell">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="addIsActive" name="isActive" checked />
                                <label class="form-check-label fw-semibold" for="addIsActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-brand">
                        <i class="bi bi-check-circle me-2"></i>Save Staff Member
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Staff Modal -->
<div class="modal fade" id="editStaffModal" tabindex="-1" aria-labelledby="editStaffModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-brand text-white">
                <h5 class="modal-title" id="editStaffModalLabel"><i class="bi bi-pencil me-2"></i>Edit Staff Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editStaffForm">
                <input type="hidden" id="editStaffId" />
                <div class="modal-body p-4">
                    <div class="admin-form-grid">
                        <div>
                            <label for="editFirstName" class="form-label fw-semibold">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editFirstName" name="firstName" required aria-required="true" />
                        </div>
                        <div>
                            <label for="editLastName" class="form-label fw-semibold">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editLastName" name="lastName" required aria-required="true" />
                        </div>
                        <div>
                            <label for="editEmail" class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" />
                        </div>
                        <div>
                            <label for="editPhone" class="form-label fw-semibold">Phone</label>
                            <input type="tel" class="form-control" id="editPhone" name="phone" />
                        </div>
                        <div class="afc-12">
                            <label for="editPhotoUrl" class="form-label fw-semibold">Photo URL</label>
                            <input type="url" class="form-control" id="editPhotoUrl" name="photoUrl" placeholder="https://..." />
                        </div>
                        <div class="afc-12">
                            <label for="editBio" class="form-label fw-semibold">Bio</label>
                            <textarea class="form-control" id="editBio" name="bio" rows="3"></textarea>
                        </div>
                        <div>
                            <label for="editSortOrder" class="form-label fw-semibold">Sort Order</label>
                            <input type="number" class="form-control" id="editSortOrder" name="sortOrder" min="0" />
                        </div>
                        <div class="admin-check-cell">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editIsActive" name="isActive" />
                                <label class="form-check-label fw-semibold" for="editIsActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-brand">
                        <i class="bi bi-check-circle me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Services Modal -->
<div class="modal fade" id="servicesModal" tabindex="-1" aria-labelledby="servicesModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-brand text-white">
                <h5 class="modal-title" id="servicesModalLabel"><i class="bi bi-grid me-2"></i>Assign Services</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted small mb-3">Select the services that <strong id="servicesModalStaffName"></strong> can perform:</p>
                <input type="hidden" id="servicesModalStaffId" />
                <div id="serviceCheckboxes" class="row g-2">
                    @foreach (var svc in services)
                    {
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input service-checkbox" type="checkbox" id="svc-assign-@svc.Id" value="@svc.Id" aria-label="@svc.Name" />
                                <label class="form-check-label" for="svc-assign-@svc.Id">
                                    @svc.Name
                                    <span class="text-muted small ms-1">(@svc.DurationMinutes min · £@svc.Price.ToString("0.00"))</span>
                                </label>
                            </div>
                        </div>
                    }
                </div>
                @if (!services.Any())
                {
                    <div class="alert alert-info mb-0"><i class="bi bi-info-circle me-2"></i>No services available. Add services first.</div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-brand" onclick="saveServices()">
                    <i class="bi bi-check-circle me-2"></i>Save Assignments
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
const token = '@accessToken';
const tenantSlug = '@tenantSlug';
const apiBase = `/api/tenants/${tenantSlug}/staff`;

// Add Staff
document.getElementById('addStaffForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const f = e.target;
    const data = {
        firstName: f.firstName.value.trim(),
        lastName: f.lastName.value.trim(),
        email: f.email.value.trim() || null,
        phone: f.phone.value.trim() || null,
        photoUrl: f.photoUrl.value.trim() || null,
        bio: f.bio.value.trim() || null,
        isActive: f.isActive.checked,
        sortOrder: parseInt(f.sortOrder.value) || 0
    };
    const resp = await fetch(apiBase, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(data)
    });
    if (resp.ok) {
        location.reload();
    } else {
        alert(`Failed to add staff member (${resp.status}). Please check your input.`);
    }
});

// Open Edit Modal
function openEditModal(btn) {
    document.getElementById('editStaffId').value = btn.dataset.staffId;
    document.getElementById('editFirstName').value = btn.dataset.firstName;
    document.getElementById('editLastName').value = btn.dataset.lastName;
    document.getElementById('editEmail').value = btn.dataset.email;
    document.getElementById('editPhone').value = btn.dataset.phone;
    document.getElementById('editPhotoUrl').value = btn.dataset.photoUrl;
    document.getElementById('editBio').value = btn.dataset.bio;
    document.getElementById('editIsActive').checked = btn.dataset.isActive === 'true';
    document.getElementById('editSortOrder').value = btn.dataset.sortOrder;
    new bootstrap.Modal(document.getElementById('editStaffModal')).show();
}

// Edit Staff
document.getElementById('editStaffForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const f = e.target;
    const id = document.getElementById('editStaffId').value;
    const data = {
        firstName: f.firstName.value.trim(),
        lastName: f.lastName.value.trim(),
        email: f.email.value.trim() || null,
        phone: f.phone.value.trim() || null,
        photoUrl: f.photoUrl.value.trim() || null,
        bio: f.bio.value.trim() || null,
        isActive: f.isActive.checked,
        sortOrder: parseInt(f.sortOrder.value) || 0
    };
    const resp = await fetch(`${apiBase}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(data)
    });
    if (resp.ok) {
        location.reload();
    } else {
        alert(`Failed to update staff member (${resp.status}).`);
    }
});

// Delete Staff
async function deleteStaff(id, name) {
    if (!confirm(`Are you sure you want to remove ${name}?`)) return;
    const resp = await fetch(`${apiBase}/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
    });
    if (resp.ok) {
        location.reload();
    } else {
        alert(`Failed to delete staff member (${resp.status}).`);
    }
}

// Open Services Modal
function openServicesModal(staffId, staffName, assignedIds) {
    document.getElementById('servicesModalStaffId').value = staffId;
    document.getElementById('servicesModalStaffName').textContent = staffName;
    document.querySelectorAll('.service-checkbox').forEach(cb => {
        cb.checked = assignedIds.includes(cb.value);
    });
    new bootstrap.Modal(document.getElementById('servicesModal')).show();
}

// Save Service Assignments
async function saveServices() {
    const staffId = document.getElementById('servicesModalStaffId').value;
    const serviceIds = Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
    const resp = await fetch(`${apiBase}/${staffId}/services`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ serviceIds })
    });
    if (resp.ok) {
        location.reload();
    } else {
        alert(`Failed to update service assignments (${resp.status}).`);
    }
}
</script>
}
