@page "/appointments"
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h5" Style="font-weight:800;">My Bookings</MudText>

        @if (_loading)
        {
            <div style="text-align:center;padding:48px;">
                <MudProgressCircular Indeterminate="true" />
            </div>
        }
        else if (!_appointments.Any())
        {
            <div style="text-align:center;padding:48px;color:var(--mud-palette-text-secondary);">
                <MudIcon Icon="@Icons.Material.Filled.EventBusy" Style="font-size:56px;opacity:.4;" />
                <MudText Style="margin-top:12px;font-weight:600;">No upcoming bookings</MudText>
                <MudText Typo="Typo.body2">Book a service to get started</MudText>
            </div>
        }
        else
        {
            @foreach (var apt in _appointments.OrderBy(a => a.StartTime))
            {
                <MudCard Elevation="1" Style="border-radius:12px;overflow:hidden;">
                    <div style="display:flex;gap:16px;padding:16px;">
                        <!-- Date block -->
                        <div style="background:var(--mud-palette-primary);color:white;border-radius:10px;padding:8px 12px;text-align:center;min-width:50px;flex-shrink:0;">
                            <div style="font-size:20px;font-weight:800;line-height:1;">@apt.StartTime.Day</div>
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;">@apt.StartTime.ToString("MMM")</div>
                        </div>
                        <!-- Details -->
                        <div style="flex:1;">
                            <div style="font-weight:700;font-size:.9375rem;">@string.Join(", ", apt.Services.Select(s => s.Name))</div>
                            <div style="font-size:.8125rem;color:var(--mud-palette-text-secondary);">
                                @apt.StartTime.ToString("h:mm tt") – @apt.EndTime.ToString("h:mm tt")
                                @if (!string.IsNullOrEmpty(apt.StaffName)) { <text> · @apt.StaffName</text> }
                            </div>
                            <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                                <MudChip T="string" Size="Size.Small" Color="@StatusColor(apt.Status)" Label="true"
                                         Style="font-size:.7rem;font-weight:700;height:20px;">
                                    @apt.Status
                                </MudChip>
                                @if (!string.IsNullOrEmpty(apt.BookingPin))
                                {
                                    <MudButton Variant="Variant.Outlined" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.QrCode"
                                               Style="height:24px;font-size:.7rem;"
                                               OnClick="@(() => ShowQr(apt))">
                                        QR
                                    </MudButton>
                                }
                            </div>
                        </div>
                        <!-- Amount -->
                        <div style="text-align:right;flex-shrink:0;">
                            <div style="font-weight:700;">£@apt.TotalAmount.ToString("0.00")</div>
                        </div>
                    </div>
                </MudCard>
            }
        }
    </MudStack>
</MudContainer>

<!-- QR Dialog -->
<MudDialog @bind-IsVisible="_showQrDialog">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="font-weight:700;">Booking QR</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedAppointment != null)
        {
            <AppointmentQrCard Appointment="_selectedAppointment" BusinessName="@_tenantName" />
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showQrDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Inject] private BookItApiService Api { get; set; } = default!;
    [Inject] private BookItAuthState Auth { get; set; } = default!;

    private List<AppointmentResponse> _appointments = new();
    private bool _loading = true;
    private bool _showQrDialog;
    private AppointmentResponse? _selectedAppointment;
    private string _tenantName = "BookIt";

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Auth.TenantSlug)) return;
        Api.SetToken(Auth.AccessToken);

        var tenant = await Api.GetTenantAsync(Auth.TenantSlug);
        _tenantName = tenant?.Name ?? "BookIt";

        _appointments = await Api.GetAppointmentsAsync(Auth.TenantSlug, DateTime.Today.AddDays(-30), DateTime.Today.AddDays(90));
        _loading = false;
    }

    private void ShowQr(AppointmentResponse apt)
    {
        _selectedAppointment = apt;
        _showQrDialog = true;
    }

    private static Color StatusColor(AppointmentStatus s) => s switch
    {
        AppointmentStatus.Confirmed => Color.Success,
        AppointmentStatus.Pending   => Color.Warning,
        AppointmentStatus.Cancelled => Color.Error,
        _                           => Color.Default
    };
}
