@using BookIt.Core.Enums
@inject ISnackbar Snackbar
@inject BookItApiService Api
@inject BookItAuthState Auth

<MudStack>
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
        <div>
            <MudText Typo="Typo.h5" Class="fw-bold">Settings</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Manage your business profile and configuration</MudText>
        </div>
    </MudStack>

    @if (_tenant == null)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudForm @ref="_form">
            <MudGrid>
                <MudItem xs="12" lg="8">
                    <!-- Business Profile -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Business Profile</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="12" sm="8">
                                    <MudTextField @bind-Value="_name" Label="Business Name" Required="true" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudSelect T="BusinessType" @bind-Value="_businessType" Label="Business Type" Variant="Variant.Outlined">
                                        @foreach (var bt in Enum.GetValues<BusinessType>())
                                        {
                                            <MudSelectItem T="BusinessType" Value="bt">@bt</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_email" Label="Contact Email" InputType="InputType.Email" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_phone" Label="Contact Phone" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="_address" Label="Address" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_city" Label="City" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_postCode" Label="Post Code" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_country" Label="Country" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_website" Label="Website" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudSelect T="string" @bind-Value="_currency" Label="Currency" Variant="Variant.Outlined">
                                        @foreach (var (code, flag, label) in _currencies)
                                        {
                                            <MudSelectItem T="string" Value="code">@flag @label</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="_vatRate" Label="VAT / Tax Rate (%)"
                                                     Variant="Variant.Outlined" Min="0" Max="100"
                                                     Adornment="Adornment.End" AdornmentText="%" />
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>

                    <!-- Branding -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Palette" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Branding &amp; Theme</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_bookingPageTitle" Label="Booking Page Title" Variant="Variant.Outlined"
                                                  Placeholder="e.g. Book with us" HelperText="Shown as the heading on your public booking page" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_bannerImageUrl" Label="Hero / Banner Image URL" Variant="Variant.Outlined"
                                                  HelperText="Full URL to a wide banner shown at the top of your booking page" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_primaryColor" Label="Custom Primary Colour (hex)" Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Circle"
                                                  AdornmentColor="Color.Primary"
                                                  HelperText="Overrides the theme's primary colour if set" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_logoUrl" Label="Logo URL" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudText Typo="Typo.subtitle2" Class="mb-1 fw-semibold">Site Theme</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                        Colour palette applied across the entire admin portal and booking page.
                                    </MudText>
                                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:.75rem;">
                                        @foreach (var t in _themes)
                                        {
                                            var theme = t;
                                            <div @onclick="@(() => _selectedTheme = theme.Value)"
                                                 style="@($"border:2px solid {((_selectedTheme == theme.Value) ? "var(--mud-palette-primary)" : "var(--mud-palette-divider)")};border-radius:12px;padding:.75rem;cursor:pointer;text-align:center;transition:.15s;background:var(--mud-palette-surface);")">
                                                <div style="@($"width:36px;height:36px;border-radius:50%;margin:0 auto .5rem;background:linear-gradient(135deg,{theme.Primary},{theme.Secondary});")"></div>
                                                <div style="font-size:.78rem;font-weight:600;">@theme.Label</div>
                                                @if (_selectedTheme == theme.Value)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Primary" Style="margin-top:4px;" />
                                                }
                                            </div>
                                        }
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>

                    <!-- Payment Settings -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.CreditCard" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Payment Settings</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <MudSwitch @bind-Value="_requirePayment" Label="Require payment at booking" Color="Color.Primary" />
                                <MudDivider />
                                <MudText Typo="Typo.subtitle2" Class="fw-semibold">In-Person Payment Options</MudText>
                                <MudStack Row="true" Spacing="4">
                                    <MudSwitch @bind-Value="_allowPayAtShop" Label="Pay at shop / reception" Color="Color.Primary" />
                                    <MudSwitch @bind-Value="_allowPayInCash" Label="Pay in cash" Color="Color.Primary" />
                                </MudStack>
                                <MudDivider />
                                <MudText Typo="Typo.subtitle2" Class="fw-semibold">Online Payment Providers</MudText>
                                <MudSwitch @bind-Value="_enableStripe" Label="Enable Stripe" Color="Color.Primary" />
                                @if (_enableStripe)
                                {
                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_stripeKey" Label="Stripe Publishable Key"
                                                          Variant="Variant.Outlined" Placeholder="pk_live_..." />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_stripeSecret" Label="Stripe Secret Key"
                                                          Variant="Variant.Outlined" InputType="InputType.Password"
                                                          Placeholder="sk_live_... (leave blank to keep)" />
                                        </MudItem>
                                    </MudGrid>
                                }
                                <MudSwitch @bind-Value="_enablePaypal" Label="Enable PayPal" Color="Color.Primary" />
                                @if (_enablePaypal)
                                {
                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_paypalClientId" Label="PayPal Client ID"
                                                          Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_paypalSecret" Label="PayPal Secret"
                                                          Variant="Variant.Outlined" InputType="InputType.Password"
                                                          Placeholder="Leave blank to keep" />
                                        </MudItem>
                                    </MudGrid>
                                }
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudSwitch @bind-Value="_enableApplePay" Label="Enable Apple Pay" Color="Color.Primary" />
                                    <MudTooltip Text="Apple Pay is processed via Stripe. Stripe must be enabled and configured above.">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Style="opacity:.5;cursor:help;" />
                                    </MudTooltip>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- File Upload Settings -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.AttachFile" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">File Upload Settings</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Set which file types customers are allowed to upload (e.g. CV for interview bookings, supporting documents). Leave blank to use defaults.
                                </MudText>
                                <MudTextField @bind-Value="_allowedFileExtensions" Label="Allowed File Extensions"
                                              Variant="Variant.Outlined" Placeholder=".pdf,.doc,.docx,.jpg,.png"
                                              HelperText="Comma-separated, e.g. .pdf,.doc,.docx" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" /> For Recruitment business types, CV upload is automatically shown on the booking form.
                                </MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- SMS Notifications -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Sms" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">SMS Notifications</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <MudSwitch @bind-Value="_enableSms" Label="Enable SMS notifications" Color="Color.Primary" />
                                @if (_enableSms)
                                {
                                    <MudSelect T="SmsProvider" @bind-Value="_smsProvider" Label="SMS Provider" Variant="Variant.Outlined">
                                        <MudSelectItem T="SmsProvider" Value="SmsProvider.ClickSend">ClickSend</MudSelectItem>
                                        <MudSelectItem T="SmsProvider" Value="SmsProvider.Twilio">Twilio</MudSelectItem>
                                    </MudSelect>

                                    @if (_smsProvider == SmsProvider.ClickSend)
                                    {
                                        <MudGrid>
                                            <MudItem xs="12" sm="4">
                                                <MudTextField @bind-Value="_clickSendUsername" Label="ClickSend Username"
                                                              Variant="Variant.Outlined" />
                                            </MudItem>
                                            <MudItem xs="12" sm="4">
                                                <MudTextField @bind-Value="_clickSendApiKey" Label="ClickSend API Key"
                                                              InputType="InputType.Password" Variant="Variant.Outlined"
                                                              Placeholder="Leave blank to keep" />
                                            </MudItem>
                                            <MudItem xs="12" sm="4">
                                                <MudTextField @bind-Value="_clickSendFromNumber" Label="From Number / Name"
                                                              Variant="Variant.Outlined" Placeholder="+447700900000" />
                                            </MudItem>
                                        </MudGrid>
                                    }
                                    else if (_smsProvider == SmsProvider.Twilio)
                                    {
                                        <MudGrid>
                                            <MudItem xs="12" sm="4">
                                                <MudTextField @bind-Value="_twilioAccountSid" Label="Twilio Account SID"
                                                              Variant="Variant.Outlined" />
                                            </MudItem>
                                            <MudItem xs="12" sm="4">
                                                <MudTextField @bind-Value="_twilioAuthToken" Label="Twilio Auth Token"
                                                              InputType="InputType.Password" Variant="Variant.Outlined"
                                                              Placeholder="Leave blank to keep" />
                                            </MudItem>
                                            <MudItem xs="12" sm="4">
                                                <MudTextField @bind-Value="_twilioFromNumber" Label="Twilio From Number"
                                                              Variant="Variant.Outlined" Placeholder="+447700900000" />
                                            </MudItem>
                                        </MudGrid>
                                    }
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- Email Notifications (SendGrid) -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Email Notifications (SendGrid)</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <MudSwitch @bind-Value="_enableEmail" Label="Enable booking confirmation &amp; reminder emails" Color="Color.Primary" />
                                @if (_enableEmail)
                                {
                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_sendGridApiKey" Label="SendGrid API Key"
                                                          InputType="InputType.Password" Variant="Variant.Outlined"
                                                          Placeholder="SG.xxxxx (leave blank to keep)" />
                                        </MudItem>
                                        <MudItem xs="12" sm="3">
                                            <MudTextField @bind-Value="_sendGridFromEmail" Label="From Email"
                                                          InputType="InputType.Email" Variant="Variant.Outlined"
                                                          Placeholder="noreply@yourdomain.com" />
                                        </MudItem>
                                        <MudItem xs="12" sm="3">
                                            <MudTextField @bind-Value="_sendGridFromName" Label="From Name"
                                                          Variant="Variant.Outlined"
                                                          Placeholder="Your Business Name" />
                                        </MudItem>
                                    </MudGrid>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- Reminder Alerts (iOS Calendar style) -->
                    <MudCard Elevation="1" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.NotificationsActive" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Reminder Alerts</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Choose when to send reminders before each appointment. Multiple alerts can be set â€” just like iOS Calendar.
                                </MudText>
                                <MudStack Row="true" Spacing="2">
                                    <MudSwitch @bind-Value="_enableEmailReminders" Label="Email reminders" Color="Color.Primary" />
                                    <MudSwitch @bind-Value="_enableSmsReminders" Label="SMS reminders" Color="Color.Primary" />
                                </MudStack>
                                <div>
                                    <MudText Typo="Typo.subtitle2" Class="mb-2 fw-semibold">Alert times</MudText>
                                    <div style="display:flex;flex-wrap:wrap;gap:.5rem;">
                                        @foreach (var alert in _reminderAlertOptions)
                                        {
                                            var a = alert;
                                            var selected = _selectedAlerts.Contains(a.Minutes);
                                            <MudChip T="int" Color="@(selected ? Color.Primary : Color.Default)"
                                                     Variant="@(selected ? Variant.Filled : Variant.Outlined)"
                                                     OnClick="@(() => ToggleAlert(a.Minutes))"
                                                     Icon="@(selected ? Icons.Material.Filled.NotificationsActive : Icons.Material.Outlined.Notifications)"
                                                     Style="cursor:pointer;">
                                                @a.Label
                                            </MudChip>
                                        }
                                    </div>
                                    @{
                                        var presetMinutes = _reminderAlertOptions.Select(o => o.Minutes).ToHashSet();
                                        var customAlerts  = _selectedAlerts.Where(m => !presetMinutes.Contains(m)).ToList();
                                    }
                                    @if (customAlerts.Any())
                                    {
                                        <div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem;">
                                            @foreach (var cm in customAlerts)
                                            {
                                                var minutes = cm;
                                                <MudChip T="int" Color="Color.Secondary" Variant="Variant.Filled"
                                                         Icon="@Icons.Material.Filled.AccessTime"
                                                         OnClose="@(() => _selectedAlerts.Remove(minutes))"
                                                         Style="cursor:default;">
                                                    @MinutesToLabel(minutes)
                                                </MudChip>
                                            }
                                        </div>
                                    }
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-3">
                                        <MudNumericField @bind-Value="_customAlertValue" Min="1" Max="999"
                                                         Variant="Variant.Outlined" Label="Value"
                                                         Margin="Margin.Dense" HideSpinButtons="true"
                                                         Style="max-width:90px;" />
                                        <MudSelect @bind-Value="_customAlertUnit" Variant="Variant.Outlined"
                                                   Margin="Margin.Dense" Style="max-width:120px;">
                                            <MudSelectItem Value="@("hours")">Hours</MudSelectItem>
                                            <MudSelectItem Value="@("days")">Days</MudSelectItem>
                                            <MudSelectItem Value="@("weeks")">Weeks</MudSelectItem>
                                        </MudSelect>
                                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                                   StartIcon="@Icons.Material.Filled.Add"
                                                   OnClick="AddCustomAlert">Add</MudButton>
                                    </MudStack>
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- Accommodation Settings (B&B / Hotel only) -->
                    @if (_businessType == BusinessType.BedAndBreakfast || _businessType == BusinessType.Hotel)
                    {
                        <MudCard Elevation="1" Class="mb-4">
                            <MudCardHeader>
                                <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Hotel" Color="Color.Primary" /></CardHeaderAvatar>
                                <CardHeaderContent><MudText Typo="Typo.h6">Accommodation Settings</MudText></CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudGrid Spacing="2">
                                    <MudItem xs="12" sm="6">
                                        <MudNumericField @bind-Value="_totalRooms" Label="Total Rooms / Units"
                                                         Variant="Variant.Outlined" Min="1" Max="9999" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.subtitle2" Class="fw-semibold mb-2">Amenities</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                            Select amenities that are available at your property. These appear on your booking page.
                                        </MudText>
                                        <div style="display:flex;flex-wrap:wrap;gap:.5rem;">
                                            @foreach (var amenity in _allAmenities)
                                            {
                                                var a = amenity;
                                                var selected = _selectedAmenities.Contains(a);
                                                <MudChip T="string" Color="@(selected ? Color.Primary : Color.Default)"
                                                         Variant="@(selected ? Variant.Filled : Variant.Outlined)"
                                                         OnClick="@(() => ToggleAmenity(a))"
                                                         Icon="@(selected ? Icons.Material.Filled.Check : null)"
                                                         Style="cursor:pointer;">
                                                    @a
                                                </MudChip>
                                            }
                                        </div>
                                    </MudItem>
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    }

                    <MudStack Row="true" Justify="Justify.FlexEnd">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                                   OnClick="Save" Disabled="_saving">
                            @(_saving ? "Saving..." : "Save Settings")
                        </MudButton>
                    </MudStack>
                </MudItem>

                <!-- Sidebar -->
                <MudItem xs="12" lg="4">
                    <MudStack Spacing="3">
                        <MudCard Elevation="1">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Class="mb-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Class="me-2" Color="Color.Primary" />
                                    Your Booking Page
                                </MudText>
                                <MudTextField Value="@BookingUrl" Label="Booking Page URL" ReadOnly="true"
                                              Variant="Variant.Outlined"
                                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                                              OnAdornmentClick="CopyUrl" />
                            </MudCardContent>
                        </MudCard>

                        <!-- Demo / Test Data -->
                        <MudCard Elevation="1">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.subtitle1" Class="fw-semibold">
                                        <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" Class="me-1" Color="Color.Secondary" />
                                        Demo Data
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Populate this account with sample bookings, customers, and calendar events for testing.
                                    </MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent Class="pt-0">
                                @if (_demoStatusLoading)
                                {
                                    <MudProgressLinear Indeterminate="true" Color="Color.Secondary" />
                                }
                                else if (_hasTenantDemoData)
                                {
                                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                                        Demo data is present on this account.
                                    </MudAlert>
                                    @if (_confirmClearDemoData)
                                    {
                                        <MudAlert Severity="Severity.Error" Dense="true" Class="mb-2">
                                            <strong>Are you sure?</strong> This will remove all demo appointments, customers, and interview slots.
                                            <MudStack Row="true" Class="mt-2" Spacing="1">
                                                <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small"
                                                           OnClick="ConfirmClearTenantDemoData" Disabled="_demoClearing">
                                                    @(_demoClearing ? "Clearingâ€¦" : "Yes, Clear")
                                                </MudButton>
                                                <MudButton Variant="Variant.Outlined" Size="Size.Small"
                                                           OnClick="@(() => _confirmClearDemoData = false)">Cancel</MudButton>
                                            </MudStack>
                                        </MudAlert>
                                    }
                                    else
                                    {
                                        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" FullWidth="true"
                                                   StartIcon="@Icons.Material.Filled.DeleteSweep"
                                                   OnClick="@(() => _confirmClearDemoData = true)">
                                            Clear Demo Data
                                        </MudButton>
                                    }
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small" FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.CloudUpload"
                                               OnClick="SeedTenantDemoData" Disabled="_demoSeeding">
                                        @(_demoSeeding ? "Seedingâ€¦" : "Seed Demo Data")
                                    </MudButton>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudForm>
    }
</MudStack>

@code {
    [Parameter] public string TenantSlug { get; set; } = "";
    [Parameter] public string HostUrl { get; set; } = "";

    private TenantResponse? _tenant;
    private MudForm? _form;
    private bool _saving;

    // Demo data state
    private bool _demoStatusLoading;
    private bool _hasTenantDemoData;
    private bool _demoSeeding;
    private bool _demoClearing;
    private bool _confirmClearDemoData;

    private string _name = "";
    private BusinessType _businessType = BusinessType.Other;
    private string _email = "";
    private string _phone = "";
    private string _address = "";
    private string _city = "";
    private string _postCode = "";
    private string _country = "";
    private string _website = "";
    private string _currency = "GBP";
    private decimal _vatRate = 0;
    private string _primaryColor = "#6c5ce7";
    private string _logoUrl = "";
    private string _bookingPageTitle = "";
    private string _bannerImageUrl = "";
    private bool _requirePayment;
    private bool _allowPayAtShop;
    private bool _allowPayInCash;
    private bool _enableStripe;
    private bool _enablePaypal;
    private bool _enableApplePay;
    private string _stripeKey = "";
    private string _stripeSecret = "";
    private string _paypalClientId = "";
    private string _paypalSecret = "";
    private TenantTheme _selectedTheme = TenantTheme.Indigo;
    private string _allowedFileExtensions = "";
    private int? _totalRooms;
    private List<string> _selectedAmenities = new();

    // SMS notification fields
    private bool _enableSms;
    private SmsProvider _smsProvider = SmsProvider.ClickSend;
    private string _clickSendUsername = "";
    private string _clickSendApiKey = "";
    private string _clickSendFromNumber = "";
    private string _twilioAccountSid = "";
    private string _twilioAuthToken = "";
    private string _twilioFromNumber = "";

    // Email notification fields
    private bool _enableEmail;
    private string _sendGridApiKey = "";
    private string _sendGridFromEmail = "";
    private string _sendGridFromName = "";

    // Reminder alert fields
    private bool _enableEmailReminders = true;
    private bool _enableSmsReminders;
    private List<int> _selectedAlerts = new() { MinutesPerDay };
    private int _customAlertValue = 1;
    private string _customAlertUnit = "hours";

    private const int MinutesPerHour = 60;
    private const int MinutesPerDay  = 1440;
    private const int MinutesPerWeek = 10080;

    private record ReminderAlertOption(int Minutes, string Label);
    private static readonly ReminderAlertOption[] _reminderAlertOptions =
    {
        new(5,             "5 min"),
        new(10,            "10 min"),
        new(15,            "15 min"),
        new(30,            "30 min"),
        new(MinutesPerHour,    "1 hour"),
        new(MinutesPerHour * 2, "2 hours"),
        new(MinutesPerHour * 3, "3 hours"),
        new(MinutesPerHour * 6, "6 hours"),
        new(MinutesPerHour * 12, "12 hours"),
        new(MinutesPerDay,      "1 day"),
        new(MinutesPerDay * 2,  "2 days"),
        new(MinutesPerWeek,     "1 week"),
    };

    private void ToggleAlert(int minutes)
    {
        if (_selectedAlerts.Contains(minutes)) _selectedAlerts.Remove(minutes);
        else _selectedAlerts.Add(minutes);
    }

    private void AddCustomAlert()
    {
        if (_customAlertValue <= 0) return;
        var minutes = _customAlertUnit switch
        {
            "days"  => _customAlertValue * MinutesPerDay,
            "weeks" => _customAlertValue * MinutesPerWeek,
            _       => _customAlertValue * MinutesPerHour,
        };
        if (!_selectedAlerts.Contains(minutes))
            _selectedAlerts.Add(minutes);
    }

    private static string MinutesToLabel(int minutes)
    {
        if (minutes % MinutesPerWeek == 0)
        {
            var w = minutes / MinutesPerWeek;
            return w == 1 ? "1 week" : $"{w} weeks";
        }
        if (minutes % MinutesPerDay == 0)
        {
            var d = minutes / MinutesPerDay;
            return d == 1 ? "1 day" : $"{d} days";
        }
        if (minutes % MinutesPerHour == 0)
        {
            var h = minutes / MinutesPerHour;
            return h == 1 ? "1 hour" : $"{h} hours";
        }
        return $"{minutes} min";
    }

    private static readonly string[] _allAmenities =
    {
        "En-suite Bathroom", "Shared Bathroom", "Shower", "Bath",
        "Single Bed", "Double Bed", "King Bed", "Bunk Beds",
        "Wi-Fi", "TV", "Air Conditioning", "Heating",
        "Parking", "Gym Access", "Swimming Pool", "Spa",
        "Restaurant", "Bar", "Room Service", "Breakfast Included",
        "Sea View", "Garden View", "Pet Friendly", "Accessible Room"
    };

    private void ToggleAmenity(string amenity)
    {
        if (_selectedAmenities.Contains(amenity)) _selectedAmenities.Remove(amenity);
        else _selectedAmenities.Add(amenity);
    }

    private string BookingUrl => $"{HostUrl}/{TenantSlug}/book";

    private static readonly (string code, string flag, string label)[] _currencies =
    {
        ("GBP", "ðŸ‡¬ðŸ‡§", "GBP â€” British Pound (Â£)"),
        ("USD", "ðŸ‡ºðŸ‡¸", "USD â€” US Dollar ($)"),
        ("EUR", "ðŸ‡ªðŸ‡º", "EUR â€” Euro (â‚¬)"),
        ("AUD", "ðŸ‡¦ðŸ‡º", "AUD â€” Australian Dollar (A$)"),
        ("CAD", "ðŸ‡¨ðŸ‡¦", "CAD â€” Canadian Dollar (C$)"),
        ("NZD", "ðŸ‡³ðŸ‡¿", "NZD â€” New Zealand Dollar (NZ$)"),
        ("SGD", "ðŸ‡¸ðŸ‡¬", "SGD â€” Singapore Dollar (S$)"),
        ("CHF", "ðŸ‡¨ðŸ‡­", "CHF â€” Swiss Franc (Fr)"),
        ("JPY", "ðŸ‡¯ðŸ‡µ", "JPY â€” Japanese Yen (Â¥)"),
        ("ZAR", "ðŸ‡¿ðŸ‡¦", "ZAR â€” South African Rand (R)"),
    };

    private record ThemeDef(TenantTheme Value, string Label, string Primary, string Secondary);

    private static readonly ThemeDef[] _themes =
    {
        new(TenantTheme.Indigo,   "Indigo",   "#6c5ce7", "#a29bfe"),
        new(TenantTheme.Ocean,    "Ocean",    "#0ea5e9", "#38bdf8"),
        new(TenantTheme.Forest,   "Forest",   "#16a34a", "#4ade80"),
        new(TenantTheme.Sunset,   "Sunset",   "#f97316", "#fb923c"),
        new(TenantTheme.Rose,     "Rose",     "#e11d48", "#fb7185"),
        new(TenantTheme.Midnight, "Midnight", "#334155", "#64748b"),
    };

    protected override async Task OnInitializedAsync()
    {
        Api.SetToken(Auth.AccessToken);
        _tenant = await Api.GetTenantAsync(TenantSlug);
        if (_tenant != null)
        {
            _name = _tenant.Name;
            _businessType = _tenant.BusinessType;
            _email = _tenant.ContactEmail ?? "";
            _phone = _tenant.ContactPhone ?? "";
            _address = _tenant.Address ?? "";
            _city = _tenant.City ?? "";
            _postCode = _tenant.PostCode ?? "";
            _country = _tenant.Country ?? "";
            _website = _tenant.Website ?? "";
            _currency = _tenant.Currency ?? "GBP";
            _vatRate = _tenant.VatRate;
            _primaryColor = _tenant.PrimaryColor ?? "#6c5ce7";
            _logoUrl = _tenant.LogoUrl ?? "";
            _bookingPageTitle = _tenant.BookingPageTitle ?? "";
            _bannerImageUrl = _tenant.BannerImageUrl ?? "";
            _requirePayment = _tenant.RequirePaymentUpfront;
            _allowPayAtShop = _tenant.AllowPayAtShop;
            _allowPayInCash = _tenant.AllowPayInCash;
            _enableStripe = _tenant.EnableStripe;
            _enablePaypal = _tenant.EnablePayPal;
            _enableApplePay = _tenant.EnableApplePay;
            _stripeKey = _tenant.StripePublishableKey ?? "";
            _paypalClientId = _tenant.PayPalClientId ?? "";
            _selectedTheme = _tenant.Theme;
            _allowedFileExtensions = _tenant.AllowedFileExtensions ?? "";
            _totalRooms = _tenant.TotalRooms;
            if (!string.IsNullOrEmpty(_tenant.AmenitiesJson))
            {
                try { _selectedAmenities = System.Text.Json.JsonSerializer.Deserialize<List<string>>(_tenant.AmenitiesJson) ?? new(); }
                catch { _selectedAmenities = new(); }
            }
            // SMS
            _enableSms = _tenant.EnableSmsNotifications;
            _smsProvider = _tenant.SmsProvider;
            _clickSendUsername = _tenant.ClickSendUsername ?? "";
            _clickSendFromNumber = _tenant.ClickSendFromNumber ?? "";
            _twilioAccountSid = _tenant.TwilioAccountSid ?? "";
            _twilioFromNumber = _tenant.TwilioFromNumber ?? "";
            // Email
            _enableEmail = _tenant.EnableEmailNotifications;
            _sendGridFromEmail = _tenant.SendGridFromEmail ?? "";
            _sendGridFromName = _tenant.SendGridFromName ?? "";
            // Reminders
            _enableEmailReminders = _tenant.EnableEmailReminders;
            _enableSmsReminders = _tenant.EnableSmsReminders;
            if (!string.IsNullOrEmpty(_tenant.ReminderAlerts))
            {
                _selectedAlerts = _tenant.ReminderAlerts.Split(',')
                    .Select(s => int.TryParse(s.Trim(), out var n) ? n : 0)
                    .Where(n => n > 0).ToList();
            }
        }

        // Load demo data status
        await LoadDemoDataStatus();
    }

    private async Task LoadDemoDataStatus()
    {
        _demoStatusLoading = true;
        try
        {
            var status = await Api.GetTenantDemoStatusAsync(TenantSlug);
            _hasTenantDemoData = status?.HasDemoData ?? false;
        }
        catch (Exception ex)
        {
            // Status check is non-critical; log to console and continue
            Console.WriteLine($"[SettingsView] Could not load demo data status: {ex.Message}");
        }
        _demoStatusLoading = false;
    }

    private async Task SeedTenantDemoData()
    {
        _demoSeeding = true;
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.SeedTenantDemoDataAsync(TenantSlug);
        Snackbar.Add(ok ? "Demo data seeded successfully." : "Failed to seed demo data.", ok ? Severity.Success : Severity.Error);
        _demoSeeding = false;
        if (ok) await LoadDemoDataStatus();
    }

    private async Task ConfirmClearTenantDemoData()
    {
        _demoClearing = true;
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.ClearTenantDemoDataAsync(TenantSlug);
        Snackbar.Add(ok ? "Demo data cleared." : "Failed to clear demo data.", ok ? Severity.Success : Severity.Error);
        _confirmClearDemoData = false;
        _demoClearing = false;
        if (ok) await LoadDemoDataStatus();
    }

    private async Task Save()
    {
        _saving = true;
        Api.SetToken(Auth.AccessToken);
        var req = new UpdateTenantRequest
        {
            Name = _name,
            BusinessType = _businessType,
            ContactEmail = _email,
            ContactPhone = _phone,
            Address = _address,
            City = _city,
            PostCode = _postCode,
            Country = _country,
            Website = _website,
            Currency = _currency,
            VatRate = _vatRate,
            PrimaryColor = _primaryColor,
            LogoUrl = _logoUrl,
            BookingPageTitle = string.IsNullOrWhiteSpace(_bookingPageTitle) ? null : _bookingPageTitle,
            BannerImageUrl = string.IsNullOrWhiteSpace(_bannerImageUrl) ? null : _bannerImageUrl,
            RequirePaymentUpfront = _requirePayment,
            AllowPayAtShop = _allowPayAtShop,
            AllowPayInCash = _allowPayInCash,
            EnableStripe = _enableStripe,
            EnablePayPal = _enablePaypal,
            EnableApplePay = _enableApplePay,
            StripePublishableKey = _stripeKey,
            StripeSecretKey = string.IsNullOrEmpty(_stripeSecret) ? null : _stripeSecret,
            PayPalClientId = _paypalClientId,
            PayPalClientSecret = string.IsNullOrEmpty(_paypalSecret) ? null : _paypalSecret,
            Theme = _selectedTheme,
            AllowedFileExtensions = string.IsNullOrWhiteSpace(_allowedFileExtensions) ? null : _allowedFileExtensions,
            TotalRooms = _totalRooms,
            AmenitiesJson = _selectedAmenities.Any() ? System.Text.Json.JsonSerializer.Serialize(_selectedAmenities) : null,
            // SMS
            SmsProvider = _smsProvider,
            ClickSendUsername = _clickSendUsername,
            ClickSendApiKey = string.IsNullOrEmpty(_clickSendApiKey) ? null : _clickSendApiKey,
            ClickSendFromNumber = _clickSendFromNumber,
            TwilioAccountSid = _twilioAccountSid,
            TwilioAuthToken = string.IsNullOrEmpty(_twilioAuthToken) ? null : _twilioAuthToken,
            TwilioFromNumber = _twilioFromNumber,
            EnableSmsNotifications = _enableSms,
            // Email
            SendGridApiKey = string.IsNullOrEmpty(_sendGridApiKey) ? null : _sendGridApiKey,
            SendGridFromEmail = _sendGridFromEmail,
            SendGridFromName = _sendGridFromName,
            EnableEmailNotifications = _enableEmail,
            // Reminders
            ReminderAlerts = _selectedAlerts.Any() ? string.Join(",", _selectedAlerts) : null,
            EnableEmailReminders = _enableEmailReminders,
            EnableSmsReminders = _enableSmsReminders,
        };
        var result = await Api.UpdateTenantAsync(TenantSlug, req);
        _saving = false;
        if (result != null)
            Snackbar.Add("Settings saved!", Severity.Success);
        else
            Snackbar.Add("Failed to save settings.", Severity.Error);
    }

    private void CopyUrl()
    {
        // JS interop for clipboard is handled at host level
        Snackbar.Add("URL copied!", Severity.Info);
    }
}
