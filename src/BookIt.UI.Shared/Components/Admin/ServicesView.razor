@inject IDialogService Dialog
@inject ISnackbar Snackbar
@inject BookItApiService Api
@inject BookItAuthState Auth

<MudStack>
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
        <div>
            <MudText Typo="Typo.h5" Class="fw-bold">Services</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Manage your bookable services</MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog">Add Service</MudButton>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (!_services.Any())
    {
        <MudCard Elevation="1">
            <MudCardContent>
                <MudStack AlignItems="AlignItems.Center" Class="py-8">
                    <MudIcon Icon="@Icons.Material.Filled.GridView" Size="Size.Large" Color="Color.Default" Style="opacity:.3;" />
                    <MudText Typo="Typo.body1" Class="fw-medium">No services yet</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Add your first service to start taking bookings</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddDialog">
                        Add Service
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <MudGrid>
            @foreach (var svc in _services)
            {
                <MudItem xs="12" sm="6" lg="4">
                    <MudCard Elevation="1" Style="height:100%;">
                        <MudCardContent>
                            <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h6" Class="fw-semibold">@svc.Name</MudText>
                                    @if (!string.IsNullOrEmpty(svc.Description))
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@svc.Description</MudText>
                                    }
                                    <MudStack Row="true" Spacing="2" Class="mt-2">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Label="true">
                                            @svc.DurationMinutes min
                                        </MudChip>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text" Label="true">
                                            £@svc.Price.ToString("0.00")
                                        </MudChip>
                                        @if (svc.AllowOnlineBooking)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text" Label="true">
                                                Online
                                            </MudChip>
                                        }
                                    </MudStack>
                                </MudStack>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                               Color="Color.Error" OnClick="@(() => DeleteService(svc))" />
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

<!-- Add Service Dialog -->
<MudDialog @bind-Visible="_addOpen" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent><MudText Typo="Typo.h6">Add Service</MudText></TitleContent>
    <DialogContent>
        <MudForm @ref="_mudForm" @bind-IsValid="_formValid">
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_newName" Label="Service Name" Required="true"
                          RequiredError="Service name is required."
                          MaxLength="200" Immediate="true"
                          Validation="@((string v) => string.IsNullOrWhiteSpace(v) ? "Service name is required." : v.Trim().Length < 2 ? "Name must be at least 2 characters." : null)"
                          Variant="Variant.Outlined" />
            <MudTextField @bind-Value="_newDesc" Label="Description" Variant="Variant.Outlined" Lines="2"
                          MaxLength="2000" />
            <MudGrid>
                <MudItem xs="6">
                    <MudNumericField T="decimal" @bind-Value="_newPrice" Label="Price (£)" Min="0" Max="1000000"
                                     Variant="Variant.Outlined" Format="0.00" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField T="int" @bind-Value="_newDuration" Label="Duration (min)" Min="5" Max="1440"
                                     Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
            <MudSwitch @bind-Value="_newOnline" Label="Allow Online Booking" Color="Color.Primary" />
        </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addOpen = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveService">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public string TenantSlug { get; set; } = "";

    private List<ServiceResponse> _services = new();
    private bool _loading = true;
    private bool _addOpen = false;
    private bool _formValid;
    private MudForm? _mudForm;

    private string _newName = "";
    private string _newDesc = "";
    private decimal _newPrice = 0;
    private int _newDuration = 60;
    private bool _newOnline = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        Api.SetToken(Auth.AccessToken);
        _services = await Api.GetServicesAsync(TenantSlug) ?? new();
        _loading = false;
    }

    private void OpenAddDialog()
    {
        _newName = ""; _newDesc = ""; _newPrice = 0; _newDuration = 60; _newOnline = true;
        _addOpen = true;
    }

    private async Task SaveService()
    {
        if (_mudForm != null) await _mudForm.Validate();
        if (!_formValid) return;

        // Sanitize
        _newName = _newName.Trim();

        Api.SetToken(Auth.AccessToken);
        var result = await Api.CreateServiceAsync(TenantSlug, new CreateServiceRequest
        {
            Name = _newName,
            Description = _newDesc,
            Price = _newPrice,
            DurationMinutes = _newDuration,
            AllowOnlineBooking = _newOnline
        });
        if (result != null)
        {
            Snackbar.Add("Service added!", Severity.Success);
            _addOpen = false;
            await LoadAsync();
        }
        else
        {
            Snackbar.Add("Failed to add service.", Severity.Error);
        }
    }

    private async Task DeleteService(ServiceResponse svc)
    {
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.DeleteServiceAsync(TenantSlug, svc.Id);
        if (ok)
        {
            Snackbar.Add($"'{svc.Name}' deleted.", Severity.Success);
            await LoadAsync();
        }
        else
        {
            Snackbar.Add("Failed to delete service.", Severity.Error);
        }
    }
}
