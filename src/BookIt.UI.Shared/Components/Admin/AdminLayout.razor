@using MudBlazor
@using Microsoft.AspNetCore.Components.Routing
@inherits LayoutComponentBase
@implements IDisposable
@inject BookItAuthState Auth
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudThemeProvider Theme="_theme" IsDarkMode="@_isDark" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <!-- ── Top App Bar ── -->
    <MudAppBar Elevation="0" Color="Color.Default" Dense="false"
               Style="height:60px;backdrop-filter:blur(14px);border-bottom:1px solid rgba(255,255,255,.07);">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Default" Edge="Edge.Start"
                       OnClick="@(() => _drawerOpen = !_drawerOpen)"
                       Style="opacity:.7;" />

        <!-- Breadcrumb title slot -->
        <MudText Typo="Typo.body1" Style="font-weight:600;letter-spacing:-.02em;opacity:.85;" Class="ml-2">
            @_pageTitle
        </MudText>

        <MudSpacer />

        <!-- Dark mode toggle -->
        <MudTooltip Text="@(_isDark ? "Light mode" : "Dark mode")">
            <MudIconButton Icon="@(_isDark ? Icons.Material.Filled.WbSunny : Icons.Material.Filled.NightlightRound)"
                           Color="Color.Default" OnClick="ToggleDark" Size="Size.Small"
                           Style="opacity:.6;" />
        </MudTooltip>

        <!-- View booking page -->
        @if (Auth.IsAuthenticated)
        {
            <MudTooltip Text="View booking page">
                <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Color="Color.Default" Size="Size.Small"
                               Href="@($"/{Auth.TenantSlug}/book")" Target="_blank"
                               Style="opacity:.6;" />
            </MudTooltip>

            <!-- Profile menu -->
            <MudMenu Dense="true" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                     Style="margin-left:8px;">
                <ActivatorContent>
                    <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.8rem;font-weight:700;color:white;letter-spacing:.02em;flex-shrink:0;">
                        @Auth.Initials
                    </div>
                </ActivatorContent>
                <ChildContent>
                    <div style="padding:.875rem 1.125rem .625rem;border-bottom:1px solid var(--mud-palette-divider);min-width:200px;">
                        <div style="font-weight:700;font-size:.875rem;letter-spacing:-.01em;">@Auth.UserName</div>
                        <div style="font-size:.75rem;opacity:.5;margin-top:1px;">@Auth.UserEmail</div>
                    </div>
                    <MudMenuItem Icon="@Icons.Material.Filled.Dashboard"
                                 Href="@($"/{Auth.TenantSlug}/admin")">Dashboard</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                 Href="@($"/{Auth.TenantSlug}/admin/settings")">Profile &amp; Settings</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.CreditCard"
                                 Href="@($"/{Auth.TenantSlug}/admin/subscriptions")">Subscription</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout"
                                 IconColor="Color.Error">Sign Out</MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
    </MudAppBar>

    <!-- ── Sidebar ── -->
    <MudDrawer @bind-Open="_drawerOpen" Elevation="0" Variant="DrawerVariant.Responsive"
               ClipMode="DrawerClipMode.Always"
               Style="background:#0d1117;border-right:1px solid rgba(255,255,255,.07);">

        <!-- Brand -->
        <MudDrawerHeader Style="padding:18px 16px 14px;">
            <div style="display:flex;align-items:center;gap:10px;">
                <div style="width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Style="color:white;" />
                </div>
                <div>
                    <div style="color:white;font-weight:800;font-size:1rem;letter-spacing:-.03em;line-height:1.1;">BookIt</div>
                    <div style="color:rgba(255,255,255,.3);font-size:.675rem;text-transform:uppercase;letter-spacing:.07em;">Admin Portal</div>
                </div>
            </div>
        </MudDrawerHeader>

        <MudNavMenu Style="padding:8px 0;">
            <!-- Main -->
            <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.25);padding:16px 20px 4px;">
                Main Menu
            </div>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin")" Match="NavLinkMatch.All"
                        Icon="@Icons.Material.Filled.GridView"
                        Style="color:rgba(255,255,255,.65);">Dashboard</MudNavLink>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin/calendar")"
                        Icon="@Icons.Material.Filled.CalendarMonth"
                        Style="color:rgba(255,255,255,.65);">Calendar</MudNavLink>

            <!-- Management -->
            <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.25);padding:16px 20px 4px;">
                Management
            </div>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin/services")"
                        Icon="@Icons.Material.Filled.Spa"
                        Style="color:rgba(255,255,255,.65);">Services</MudNavLink>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin/forms")"
                        Icon="@Icons.Material.Filled.Assignment"
                        Style="color:rgba(255,255,255,.65);">Booking Forms</MudNavLink>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin/interviews")"
                        Icon="@Icons.Material.Filled.Groups"
                        Style="color:rgba(255,255,255,.65);">Interviews</MudNavLink>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/book")" Target="_blank"
                        Icon="@Icons.Material.Filled.OpenInNew"
                        Style="color:rgba(255,255,255,.65);">Booking Page</MudNavLink>

            <!-- Settings -->
            <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.25);padding:16px 20px 4px;">
                Account
            </div>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin/settings")"
                        Icon="@Icons.Material.Filled.Tune"
                        Style="color:rgba(255,255,255,.65);">Settings</MudNavLink>
            <MudNavLink Href="@($"/{Auth.TenantSlug}/admin/subscriptions")"
                        Icon="@Icons.Material.Filled.CreditCard"
                        Style="color:rgba(255,255,255,.65);">Subscription</MudNavLink>
        </MudNavMenu>

        <!-- User footer strip -->
        <MudSpacer />
        <div style="padding:12px 14px;border-top:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:10px;">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#6c5ce7,#a29bfe);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:white;flex-shrink:0;">
                @Auth.Initials
            </div>
            <div style="flex:1;overflow:hidden;">
                <div style="color:rgba(255,255,255,.8);font-size:.8125rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    @Auth.UserName
                </div>
                <div style="color:rgba(255,255,255,.3);font-size:.7rem;">Administrator</div>
            </div>
            <MudIconButton Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Color="Color.Default"
                           OnClick="Logout" Style="opacity:.45;" />
        </div>
    </MudDrawer>

    <!-- ── Main Content ── -->
    <MudMainContent Style="background:var(--mud-palette-background);">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Style="padding:28px 28px 40px;">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isDark = true;
    private MudTheme _theme = BookItTheme.Default;

    private string _pageTitle => Nav.Uri.TrimEnd('/').Split('/').LastOrDefault(x => !string.IsNullOrEmpty(x)) switch
    {
        "admin"         => "Dashboard",
        "calendar"      => "Calendar",
        "services"      => "Services",
        "forms"         => "Booking Forms",
        "interviews"    => "Interviews",
        "settings"      => "Settings",
        "subscriptions" => "Subscription",
        _               => "Dashboard"
    };

    protected override void OnInitialized() => Auth.OnChange += StateHasChanged;

    private void ToggleDark() => _isDark = !_isDark;

    private void Logout()
    {
        Auth.Clear();
        Nav.NavigateTo("/login");
    }

    public void Dispose() => Auth.OnChange -= StateHasChanged;
}
