@using MudBlazor
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.JSInterop
@inherits LayoutComponentBase
@implements IDisposable
@inject BookItAuthState Auth
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IJSRuntime Js
@inject BookItApiService Api

<MudThemeProvider Theme="_theme" IsDarkMode="@_isDark" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <!-- ── Top App Bar ── -->
    <MudAppBar Elevation="0" Color="Color.Default" Dense="false"
               Style="@AppBarStyle">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Default" Edge="Edge.Start"
                       OnClick="@(() => _drawerOpen = !_drawerOpen)"
                       Style="opacity:.7;" />

        <!-- Breadcrumb title slot -->
        <MudText Typo="Typo.body1" Style="font-weight:600;letter-spacing:-.02em;opacity:.85;" Class="ml-2">
            @_pageTitle
        </MudText>

        <MudSpacer />

        <!-- Dark mode toggle -->
        <MudTooltip Text="@(_isDark ? "Light mode" : "Dark mode")">
            <MudIconButton Icon="@(_isDark ? Icons.Material.Filled.WbSunny : Icons.Material.Filled.NightlightRound)"
                           Color="Color.Default" OnClick="ToggleDark" Size="Size.Small"
                           Style="opacity:.6;" />
        </MudTooltip>

        <!-- View booking page -->
        @if (Auth.IsAuthenticated)
        {
            <MudTooltip Text="View booking page">
                <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Color="Color.Default" Size="Size.Small"
                               Href="@($"/{NavTenantSlug}/book")" Target="_blank"
                               Style="opacity:.6;" />
            </MudTooltip>

            <!-- Profile menu -->
            <MudMenu Dense="true" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                     Style="margin-left:8px;">
                <ActivatorContent>
                    <div style="@($"width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,{_themePrimary},{_themeSecondary});display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.8rem;font-weight:700;color:white;letter-spacing:.02em;flex-shrink:0;")">
                        @Auth.Initials
                    </div>
                </ActivatorContent>
                <ChildContent>
                    <div style="padding:.875rem 1.125rem .625rem;border-bottom:1px solid var(--mud-palette-divider);min-width:200px;">
                        <div style="font-weight:700;font-size:.875rem;letter-spacing:-.01em;">@Auth.UserName</div>
                        <div style="font-size:.75rem;opacity:.5;margin-top:1px;">@Auth.UserEmail</div>
                    </div>
                    <MudMenuItem Icon="@Icons.Material.Filled.Dashboard"
                                 Href="@($"/{NavTenantSlug}/admin")">Dashboard</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                 Href="@($"/{NavTenantSlug}/admin/settings")">Profile &amp; Settings</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.CreditCard"
                                 Href="@($"/{NavTenantSlug}/admin/subscriptions")">Subscription</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Info" OnClick="@(() => _aboutOpen = true)"
                                 IconColor="Color.Default">About</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout"
                                 IconColor="Color.Error">Sign Out</MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
    </MudAppBar>

    <!-- ── Sidebar ── -->
    <MudDrawer @bind-Open="_drawerOpen" Elevation="0" Variant="DrawerVariant.Responsive"
               ClipMode="DrawerClipMode.Always"
               Style="@DrawerStyle">

        <!-- Brand -->
        <MudDrawerHeader Style="padding:18px 16px 14px;">
            <div style="display:flex;align-items:center;gap:10px;">
                <div style="@($"width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,{_themePrimary},{_themeSecondary});display:flex;align-items:center;justify-content:center;flex-shrink:0;")">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Style="color:white;" />
                </div>
                <div>
                    <div style="@BrandNameStyle">BookIt</div>
                    <div style="@BrandSubStyle">Admin Portal</div>
                </div>
            </div>
        </MudDrawerHeader>

        <MudNavMenu Style="padding:8px 0;">
            <!-- Main -->
            <div style="@SectionLabelStyle">
                Main Menu
            </div>
            <MudNavLink Href="@($"/{NavTenantSlug}/admin")" Match="NavLinkMatch.All"
                        Icon="@Icons.Material.Filled.GridView"
                        Style="@NavLinkStyle">Dashboard</MudNavLink>
            <MudNavLink Href="@($"/{NavTenantSlug}/admin/calendar")"
                        Icon="@Icons.Material.Filled.CalendarMonth"
                        Style="@NavLinkStyle">Calendar</MudNavLink>
            <MudNavLink Href="@($"/{NavTenantSlug}/admin/bookings")"
                        Icon="@Icons.Material.Filled.BookOnline"
                        Style="@NavLinkStyle">Bookings</MudNavLink>

            <!-- Management -->
            <div style="@SectionLabelStyle">
                Management
            </div>
            @if (!Auth.IsStaffOnly)
            {
                <MudNavLink Href="@($"/{NavTenantSlug}/admin/services")"
                            Icon="@Icons.Material.Filled.Spa"
                            Style="@NavLinkStyle">Services</MudNavLink>
                <MudNavLink Href="@($"/{NavTenantSlug}/admin/rooms")"
                            Icon="@Icons.Material.Filled.Hotel"
                            Style="@NavLinkStyle">Rooms &amp; Lodging</MudNavLink>
            }
            <MudNavLink Href="@($"/{NavTenantSlug}/admin/customers")"
                        Icon="@Icons.Material.Filled.People"
                        Style="@NavLinkStyle">Customers</MudNavLink>
            @if (!Auth.IsStaffOnly)
            {
                <MudNavGroup Title="Booking Forms" Icon="@Icons.Material.Filled.Assignment"
                             Style="@NavLinkStyle">
                    <MudNavLink Href="@($"/{NavTenantSlug}/admin/forms")"
                                Icon="@Icons.Material.Filled.List"
                                Style="@NavLinkStyle">All Forms</MudNavLink>
                    <MudNavLink Href="@($"/{NavTenantSlug}/admin/forms/builder")"
                                Icon="@Icons.Material.Filled.Build"
                                Style="@NavLinkStyle">Form Builder</MudNavLink>
                </MudNavGroup>
            }
            <MudNavLink Href="@($"/{NavTenantSlug}/admin/interviews")"
                        Icon="@Icons.Material.Filled.Groups"
                        Style="@NavLinkStyle">Interviews</MudNavLink>
            <MudNavLink Href="@($"/{NavTenantSlug}/book")" Target="_blank"
                        Icon="@Icons.Material.Filled.OpenInNew"
                        Style="@NavLinkStyle">Booking Page</MudNavLink>

            <!-- Settings -->
            @if (!Auth.IsStaffOnly)
            {
                <div style="@SectionLabelStyle">
                    Account
                </div>
                <MudNavLink Href="@($"/{NavTenantSlug}/admin/settings")"
                            Icon="@Icons.Material.Filled.Tune"
                            Style="@NavLinkStyle">Settings</MudNavLink>
                <MudNavLink Href="@($"/{NavTenantSlug}/admin/email-templates")"
                            Icon="@Icons.Material.Filled.MarkEmailRead"
                            Style="@NavLinkStyle">Email Templates</MudNavLink>
                <MudNavLink Href="@($"/{NavTenantSlug}/admin/subscriptions")"
                            Icon="@Icons.Material.Filled.CreditCard"
                            Style="@NavLinkStyle">Subscription</MudNavLink>
                <MudNavLink Href="@($"/{NavTenantSlug}/admin/audit-trail")"
                            Icon="@Icons.Material.Filled.ManageSearch"
                            Style="@NavLinkStyle">Audit Trail</MudNavLink>
            }

            <!-- Super Admin -->
            @if (Auth.IsSuperAdmin)
            {
                <div style="@SectionLabelStyle">Super Admin</div>
                <MudNavLink Href="/superadmin/clients"
                            Icon="@Icons.Material.Filled.Business"
                            Style="@NavLinkStyle">Clients</MudNavLink>
                <MudNavLink Href="/superadmin/subscription-tiers"
                            Icon="@Icons.Material.Filled.Layers"
                            Style="@NavLinkStyle">Subscription Tiers</MudNavLink>
                <MudNavLink Href="/superadmin/database"
                            Icon="@Icons.Material.Filled.Storage"
                            Style="@NavLinkStyle">Database</MudNavLink>
            }
        </MudNavMenu>

        <!-- User footer strip -->
        <MudSpacer />
        <div style="@FooterStyle">
            <div style="@($"width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,{_themePrimary},{_themeSecondary});display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:white;flex-shrink:0;")">
                @Auth.Initials
            </div>
            <div style="flex:1;overflow:hidden;">
                <div style="@FooterNameStyle">
                    @Auth.UserName
                </div>
                <div style="@FooterRoleStyle">@(Auth.IsStaffOnly ? "Staff" : Auth.IsManagerOrAbove ? "Administrator" : "User")</div>
            </div>
            <MudIconButton Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Color="Color.Default"
                           OnClick="Logout" Style="opacity:.45;" />
        </div>
    </MudDrawer>

    <!-- ── Main Content ── -->
    <MudMainContent Style="background:var(--mud-palette-background);">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Style="padding:28px 28px 40px;">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<!-- About dialog -->
<MudDialog @bind-Visible="_aboutOpen" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Class="fw-bold">About BookIt</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudSimpleTable Elevation="0" Dense="true" Style="width:100%;">
            <tbody>
                <tr>
                    <td style="font-weight:600;opacity:.6;width:130px;">Application</td>
                    <td>BookIt Admin Portal</td>
                </tr>
                <tr>
                    <td style="font-weight:600;opacity:.6;">Version</td>
                    <td>@_appVersion</td>
                </tr>
                <tr>
                    <td style="font-weight:600;opacity:.6;">API Version</td>
                    <td>@_apiVersion</td>
                </tr>
                <tr>
                    <td style="font-weight:600;opacity:.6;">Licence</td>
                    <td>@(Auth.TenantSlug ?? "—")</td>
                </tr>
                <tr>
                    <td style="font-weight:600;opacity:.6;">Environment</td>
                    <td>Production</td>
                </tr>
            </tbody>
        </MudSimpleTable>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-3" Style="display:block;text-align:center;">
            © @DateTime.UtcNow.Year BookIt. All rights reserved.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _aboutOpen = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _drawerOpen = true;
    private bool _isDark = true;
    private bool _aboutOpen = false;
    private string _appVersion = "1.0.0";
    private string _apiVersion = "1.0.0";
    private MudTheme _theme = BookItTheme.Default;
    private string _themePrimary = BookItTheme.PrimaryOf(TenantTheme.Indigo);
    private string _themeSecondary = BookItTheme.SecondaryOf(TenantTheme.Indigo);

    // ── Computed styles that flip between dark and light mode ──────────────────

    private string AppBarStyle =>
        $"height:60px;backdrop-filter:blur(14px);border-bottom:1px solid {(_isDark ? "rgba(255,255,255,.07)" : "rgba(0,0,0,.09)")};";

    private string DrawerStyle =>
        $"background:{(_isDark ? "#0d1117" : "var(--mud-palette-surface)")};border-right:1px solid {(_isDark ? "rgba(255,255,255,.07)" : "rgba(0,0,0,.09)")};";

    private string BrandNameStyle =>
        $"color:{(_isDark ? "white" : "var(--mud-palette-text-primary)")};font-weight:800;font-size:1rem;letter-spacing:-.03em;line-height:1.1;";

    private string BrandSubStyle =>
        $"color:{(_isDark ? "rgba(255,255,255,.3)" : "rgba(0,0,0,.4)")};font-size:.675rem;text-transform:uppercase;letter-spacing:.07em;";

    private string SectionLabelStyle =>
        $"font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;padding:16px 20px 4px;color:{(_isDark ? "rgba(255,255,255,.25)" : "rgba(0,0,0,.38)")};";

    private string NavLinkStyle =>
        $"color:{(_isDark ? "rgba(255,255,255,.65)" : "var(--mud-palette-text-primary)")};";

    private string FooterStyle =>
        $"padding:12px 14px;border-top:1px solid {(_isDark ? "rgba(255,255,255,.07)" : "rgba(0,0,0,.09)")};display:flex;align-items:center;gap:10px;";

    private string FooterNameStyle =>
        $"color:{(_isDark ? "rgba(255,255,255,.8)" : "var(--mud-palette-text-primary)")};font-size:.8125rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";

    private string FooterRoleStyle =>
        $"color:{(_isDark ? "rgba(255,255,255,.3)" : "rgba(0,0,0,.45)")};font-size:.7rem;";

    /// <summary>
    /// Returns the tenant slug to use for nav links.
    /// When a super admin browses a different tenant's admin pages (e.g. /demo-barber/admin),
    /// the URL-based slug takes priority over <c>Auth.TenantSlug</c> so that sidebar
    /// links stay scoped to the tenant being viewed.
    /// </summary>
    private string NavTenantSlug
    {
        get
        {
            // Extract /{slug}/admin... pattern from current URL
            var path = new Uri(Nav.Uri).AbsolutePath.TrimStart('/');
            var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
            if (segments.Length >= 2 && segments[1].Equals("admin", StringComparison.OrdinalIgnoreCase))
                return segments[0];
            return Auth.TenantSlug ?? "";
        }
    }

    private string _pageTitle => Nav.Uri.TrimEnd('/').Split('/').LastOrDefault(x => !string.IsNullOrEmpty(x)) switch
    {
        "admin"            => "Dashboard",
        "calendar"         => "Calendar",
        "bookings"         => "Bookings",
        "services"         => "Services",
        "rooms"            => "Rooms & Lodging",
        "customers"        => "Customers",
        "forms"            => "Booking Forms",
        "builder"          => "Form Builder",
        "interviews"       => "Interviews",
        "settings"         => "Settings",
        "email-templates"  => "Email Templates",
        "subscriptions"    => "Subscription",
        "audit-trail"      => "Audit Trail",
        _                  => "Dashboard"
    };

    protected override void OnInitialized()
    {
        Auth.OnChange += StateHasChanged;
        Nav.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
        => StateHasChanged();

    private async Task ToggleDark()
    {
        _isDark = !_isDark;
        await Js.InvokeVoidAsync("localStorage.setItem", "bookit-theme", _isDark ? "dark" : "light");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        var stored = await Js.InvokeAsync<string?>("localStorage.getItem", "bookit-theme");
        // Default to dark unless the user has explicitly chosen light
        var preferDark = stored != "light";
        if (preferDark != _isDark) { _isDark = preferDark; StateHasChanged(); }

        // Set app version from assembly
        var asm = System.Reflection.Assembly.GetExecutingAssembly();
        var ver = asm.GetName().Version;
        _appVersion = ver != null ? $"{ver.Major}.{ver.Minor}.{ver.Build}" : "1.0.0";

        // Load tenant theme and API version
        if (Auth.IsAuthenticated && !string.IsNullOrEmpty(Auth.TenantSlug))
        {
            Api.SetToken(Auth.AccessToken);
            var tenant = await Api.GetTenantAsync(Auth.TenantSlug);
            if (tenant != null)
            {
                _theme = BookItTheme.FromTenantTheme(tenant.Theme);
                _themePrimary = BookItTheme.PrimaryOf(tenant.Theme);
                _themeSecondary = BookItTheme.SecondaryOf(tenant.Theme);
            }
            var apiVersion = await Api.GetApiVersionAsync();
            if (!string.IsNullOrEmpty(apiVersion))
                _apiVersion = apiVersion;
            StateHasChanged();
        }
    }

    private void Logout()
    {
        Auth.Clear();
        Nav.NavigateTo("/login");
    }

    public void Dispose()
    {
        Auth.OnChange -= StateHasChanged;
        Nav.LocationChanged -= OnLocationChanged;
    }
}
