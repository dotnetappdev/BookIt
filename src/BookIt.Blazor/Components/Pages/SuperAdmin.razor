@page "/super-admin"
@rendermode InteractiveServer
@using MudBlazor
@using BookIt.UI.Shared.Services
@using BookIt.Core.DTOs
@inject BookItApiService Api
@inject BookItAuthState Auth
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IJSRuntime Js

<PageTitle>Super Admin — BookIt</PageTitle>

<MudThemeProvider IsDarkMode="true" />
<MudPopoverProvider />
<MudSnackbarProvider />
<MudDialogProvider />

<div style="min-height:100vh;background:#07071a;color:white;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">

    <!-- Top bar -->
    <div style="background:#0d1117;border-bottom:1px solid rgba(255,255,255,.07);padding:14px 24px;
                display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);
                        display:flex;align-items:center;justify-content:center;">
                <span style="font-size:.9rem;font-weight:700;">B</span>
            </div>
            <div>
                <div style="font-size:1rem;font-weight:700;">BookIt Super Admin</div>
                <div style="font-size:.72rem;color:rgba(255,255,255,.4);">Tenant Management Console</div>
            </div>
        </div>
        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.Logout"
                   OnClick="@(() => Nav.NavigateTo("/login"))">Sign Out</MudButton>
    </div>

    <div style="max-width:1300px;margin:0 auto;padding:32px 24px;">

        @if (!_authorized)
        {
            <MudCard Elevation="2" Style="max-width:400px;margin:80px auto;">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Large" Color="Color.Warning" />
                        <MudText Typo="Typo.h6">Super Admin Access Required</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                            Please sign in with a BookIt super-admin account.
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   OnClick="@(() => Nav.NavigateTo("/login?returnUrl=/super-admin"))">
                            Sign In
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }
        else
        {
            <!-- Tab navigation -->
            <MudTabs Elevation="0" Rounded="false" ApplyEffectsToContainer="true"
                     Class="mb-4" Style="background:transparent;">
                <MudTabPanel Text="Tenants" Icon="@Icons.Material.Filled.Business">

            <!-- Stats row -->
            <MudGrid Spacing="3" Class="mb-4">
                <MudItem xs="12" sm="3">
                    <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:20px;border-top:3px solid #6c5ce7;">
                        <div style="font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#6c5ce7,#a29bfe);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
                            @_tenants.Count
                        </div>
                        <div style="font-size:.8rem;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.06em;">Total Tenants</div>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="3">
                    <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:20px;border-top:3px solid #00b894;">
                        <div style="font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#00b894,#55efc4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
                            @_tenants.Count(t => t.IsActive)
                        </div>
                        <div style="font-size:.8rem;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.06em;">Active Tenants</div>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="3">
                    <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:20px;border-top:3px solid #0984e3;">
                        <div style="font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#0984e3,#74b9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
                            @_tenants.Sum(t => t.CustomerCount)
                        </div>
                        <div style="font-size:.8rem;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.06em;">Total Customers</div>
                    </div>
                </MudItem>
                <MudItem xs="12" sm="3">
                    <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:20px;border-top:3px solid #e17055;">
                        <div style="font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#e17055,#fab1a0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
                            @_tenants.Sum(t => t.AppointmentCount)
                        </div>
                        <div style="font-size:.8rem;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.06em;">Total Bookings</div>
                    </div>
                </MudItem>
            </MudGrid>

            <!-- Header + New Tenant -->
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                <div>
                    <MudText Typo="Typo.h5" Style="color:white;font-weight:700;">Client Tenants</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Manage all BookIt client accounts and their tenant IDs</MudText>
                </div>
                <MudStack Row="true" Spacing="2">
                    <MudTextField @bind-Value="_search" Placeholder="Search tenants…"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width:220px;" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="OpenSetupPage">New Tenant</MudButton>
                </MudStack>
            </MudStack>

            @if (_loading)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else if (!FilteredTenants.Any())
            {
                <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:48px;text-align:center;">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Style="opacity:.3;" />
                    <MudText Typo="Typo.body1" Style="margin-top:12px;opacity:.5;">No tenants found.</MudText>
                </div>
            }
            else
            {
                <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;overflow:hidden;">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:1px solid rgba(255,255,255,.07);">
                                <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Business</th>
                                <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Tenant ID</th>
                                <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Type</th>
                                <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Contact</th>
                                <th style="padding:12px 16px;text-align:center;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Customers</th>
                                <th style="padding:12px 16px;text-align:center;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Bookings</th>
                                <th style="padding:12px 16px;text-align:center;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Status</th>
                                <th style="padding:12px 16px;text-align:right;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in FilteredTenants)
                            {
                                <tr style="border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;"
                                    onmouseenter="this.style.background='rgba(108,92,231,.06)'"
                                    onmouseleave="this.style.background='transparent'">
                                    <td style="padding:14px 16px;">
                                        <div style="font-weight:600;font-size:.9rem;">@t.Name</div>
                                        <div style="font-size:.75rem;color:rgba(255,255,255,.4);">/@t.Slug</div>
                                    </td>
                                    <td style="padding:14px 16px;">
                                        <code style="font-size:.72rem;background:rgba(255,255,255,.06);padding:3px 7px;border-radius:4px;color:#a29bfe;letter-spacing:.03em;">
                                            @t.Id.ToString("D")
                                        </code>
                                    </td>
                                    <td style="padding:14px 16px;">
                                        <span style="font-size:.78rem;background:rgba(108,92,231,.15);color:#a29bfe;padding:3px 8px;border-radius:20px;">
                                            @t.BusinessTypeName
                                        </span>
                                    </td>
                                    <td style="padding:14px 16px;">
                                        <div style="font-size:.82rem;">@(t.ContactEmail ?? "—")</div>
                                        <div style="font-size:.75rem;color:rgba(255,255,255,.4);">@(t.ContactPhone ?? "")</div>
                                    </td>
                                    <td style="padding:14px 16px;text-align:center;font-size:.9rem;font-weight:600;">@t.CustomerCount</td>
                                    <td style="padding:14px 16px;text-align:center;font-size:.9rem;font-weight:600;">@t.AppointmentCount</td>
                                    <td style="padding:14px 16px;text-align:center;">
                                        @if (t.IsActive)
                                        {
                                            <span style="font-size:.75rem;background:rgba(0,184,148,.15);color:#55efc4;padding:3px 9px;border-radius:20px;">Active</span>
                                        }
                                        else
                                        {
                                            <span style="font-size:.75rem;background:rgba(225,112,85,.15);color:#fab1a0;padding:3px 9px;border-radius:20px;">Inactive</span>
                                        }
                                    </td>
                                    <td style="padding:14px 16px;text-align:right;">
                                        <MudTooltip Text="View tenant admin dashboard">
                                            <MudIconButton Icon="@Icons.Material.Filled.Dashboard" Size="Size.Small"
                                                           Style="color:rgba(255,255,255,.6);"
                                                           OnClick="@(() => OpenNewTab($"/{t.Slug}/admin"))" />
                                        </MudTooltip>
                                        <MudTooltip Text="View public booking page">
                                            <MudIconButton Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small"
                                                           Style="color:rgba(255,255,255,.6);"
                                                           OnClick="@(() => OpenNewTab($"/{t.Slug}/book"))" />
                                        </MudTooltip>
                                        <MudTooltip Text="Copy tenant ID">
                                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                                           Style="color:rgba(255,255,255,.5);"
                                                           OnClick="@(() => CopyTenantId(t))" />
                                        </MudTooltip>
                                        @if (_pendingDeleteId == t.Id)
                                        {
                                            <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Filled"
                                                       OnClick="@(() => ConfirmDeleteTenant(t))">Delete?</MudButton>
                                            <MudButton Size="Size.Small" Style="color:rgba(255,255,255,.5);"
                                                       OnClick="@(() => _pendingDeleteId = null)">Cancel</MudButton>
                                        }
                                        else
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                           Style="color:#e17055;"
                                                           OnClick="@(() => _pendingDeleteId = t.Id)" />
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
                </MudTabPanel>

                <!-- Clients Tab -->
                <MudTabPanel Text="Clients" Icon="@Icons.Material.Filled.Groups">
                    <div style="text-align:center;padding:60px 20px;">
                        <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Large" Style="color:#6c5ce7;font-size:4rem;margin-bottom:16px;" />
                        <MudText Typo="Typo.h5" Class="mb-2" Style="font-weight:700;">Client Management</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                            Manage client accounts and their staff associations
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                                   Href="/superadmin/clients" StartIcon="@Icons.Material.Filled.ArrowForward">
                            Go to Client Management
                        </MudButton>
                    </div>
                </MudTabPanel>

                <!-- Users Tab -->
                <MudTabPanel Text="Users" Icon="@Icons.Material.Filled.People" OnClick="LoadUsers">
                    <MudStack Spacing="3" Class="mt-2">
                        <!-- Header + search -->
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-1">
                            <div>
                                <MudText Typo="Typo.h5" Style="color:white;font-weight:700;">Application Users</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">View and manage all user accounts and their roles</MudText>
                            </div>
                            <MudStack Row="true" Spacing="2">
                                <MudTextField @bind-Value="_userSearch" Placeholder="Search users…"
                                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                              Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width:200px;"
                                              Immediate="true" />
                                <MudSelect T="string" @bind-Value="_userRoleFilter" Label="Role" Variant="Variant.Outlined"
                                           Margin="Margin.Dense" Style="min-width:140px;">
                                    <MudSelectItem T="string" Value='""'>All Roles</MudSelectItem>
                                    <MudSelectItem T="string" Value='"SuperAdmin"'>SuperAdmin</MudSelectItem>
                                    <MudSelectItem T="string" Value='"TenantAdmin"'>TenantAdmin</MudSelectItem>
                                    <MudSelectItem T="string" Value='"Manager"'>Manager</MudSelectItem>
                                    <MudSelectItem T="string" Value='"Staff"'>Staff</MudSelectItem>
                                    <MudSelectItem T="string" Value='"Customer"'>Customer</MudSelectItem>
                                </MudSelect>
                            </MudStack>
                        </MudStack>

                        @if (_usersLoading)
                        {
                            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                        }
                        else if (!FilteredUsers.Any())
                        {
                            <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:48px;text-align:center;">
                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Style="opacity:.3;" />
                                <MudText Typo="Typo.body1" Style="margin-top:12px;opacity:.5;">No users found.</MudText>
                            </div>
                        }
                        else
                        {
                            <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;overflow:hidden;">
                                <table style="width:100%;border-collapse:collapse;">
                                    <thead>
                                        <tr style="border-bottom:1px solid rgba(255,255,255,.07);">
                                            <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">User</th>
                                            <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Role</th>
                                            <th style="padding:12px 16px;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Tenant</th>
                                            <th style="padding:12px 16px;text-align:center;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Status</th>
                                            <th style="padding:12px 16px;text-align:right;font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:rgba(255,255,255,.35);">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var u in FilteredUsers)
                                        {
                                            <tr style="border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;"
                                                onmouseenter="this.style.background='rgba(108,92,231,.06)'"
                                                onmouseleave="this.style.background='transparent'">
                                                <td style="padding:14px 16px;">
                                                    <div style="font-weight:600;font-size:.9rem;">@u.FullName</div>
                                                    <div style="font-size:.75rem;color:rgba(255,255,255,.4);">@u.Email</div>
                                                </td>
                                                <td style="padding:14px 16px;">
                                                    @{
                                                        var roleColor = u.RoleName switch {
                                                            "SuperAdmin"  => "#e17055",
                                                            "TenantAdmin" => "#6c5ce7",
                                                            "Manager"     => "#0984e3",
                                                            "Staff"       => "#00b894",
                                                            _             => "#636e72"
                                                        };
                                                        var roleBg = u.RoleName switch {
                                                            "SuperAdmin"  => "rgba(225,112,85,.15)",
                                                            "TenantAdmin" => "rgba(108,92,231,.15)",
                                                            "Manager"     => "rgba(9,132,227,.15)",
                                                            "Staff"       => "rgba(0,184,148,.15)",
                                                            _             => "rgba(99,110,114,.15)"
                                                        };
                                                    }
                                                    <span style="font-size:.78rem;background:@roleBg;color:@roleColor;padding:3px 8px;border-radius:20px;">
                                                        @u.RoleName
                                                    </span>
                                                </td>
                                                <td style="padding:14px 16px;">
                                                    <div style="font-size:.82rem;">@u.TenantName</div>
                                                    <div style="font-size:.75rem;color:rgba(255,255,255,.4);">/@u.TenantSlug</div>
                                                </td>
                                                <td style="padding:14px 16px;text-align:center;">
                                                    @if (u.IsDeleted)
                                                    {
                                                        <span style="font-size:.75rem;background:rgba(225,112,85,.15);color:#fab1a0;padding:3px 9px;border-radius:20px;">Disabled</span>
                                                    }
                                                    else
                                                    {
                                                        <span style="font-size:.75rem;background:rgba(0,184,148,.15);color:#55efc4;padding:3px 9px;border-radius:20px;">Active</span>
                                                    }
                                                </td>
                                                <td style="padding:14px 16px;text-align:right;">
                                                    <MudTooltip Text="Change role">
                                                        <MudSelect T="BookIt.Core.Enums.UserRole"
                                                                   Value="u.Role"
                                                                   ValueChanged="@(r => ChangeUserRole(u, r))"
                                                                   Variant="Variant.Outlined" Margin="Margin.Dense"
                                                                   Style="min-width:120px;font-size:.8rem;"
                                                                   Dense="true">
                                                            @foreach (var r in Enum.GetValues<BookIt.Core.Enums.UserRole>())
                                                            {
                                                                <MudSelectItem T="BookIt.Core.Enums.UserRole" Value="r">@r</MudSelectItem>
                                                            }
                                                        </MudSelect>
                                                    </MudTooltip>
                                                    @if (!u.IsDeleted)
                                                    {
                                                        @if (_pendingDeleteUserId == u.Id)
                                                        {
                                                            <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Filled"
                                                                       OnClick="@(() => ConfirmDeleteUser(u))">Disable?</MudButton>
                                                            <MudButton Size="Size.Small" Style="color:rgba(255,255,255,.5);"
                                                                       OnClick="@(() => _pendingDeleteUserId = null)">Cancel</MudButton>
                                                        }
                                                        else
                                                        {
                                                            <MudIconButton Icon="@Icons.Material.Filled.PersonOff" Size="Size.Small"
                                                                           Style="color:#e17055;"
                                                                           OnClick="@(() => _pendingDeleteUserId = u.Id)" />
                                                        }
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </MudStack>
                </MudTabPanel>

                <!-- Database Management Tab -->
                <MudTabPanel Text="Database" Icon="@Icons.Material.Filled.Storage">
                    <div style="text-align:center;padding:60px 20px;">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Large" Style="color:#6c5ce7;font-size:4rem;margin-bottom:16px;" />
                        <MudText Typo="Typo.h5" Class="mb-2" Style="font-weight:700;">Database Management</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                            Seed demo data or clear the database
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                                   Href="/superadmin/database" StartIcon="@Icons.Material.Filled.ArrowForward">
                            Go to Database Management
                        </MudButton>
                    </div>
                </MudTabPanel>

                <!-- RevenueCat Configuration — SuperAdmin only -->
                <MudTabPanel Text="RevenueCat Config" Icon="@Icons.Material.Filled.Subscriptions">
                    <MudStack Spacing="4" Class="mt-4">
                        <div>
                            <MudText Typo="Typo.h6" Style="color:white;font-weight:700;">RevenueCat Platform Configuration</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Set the platform-wide RevenueCat API key and configure subscription tier prices.
                                These settings are only visible to BookIt super-admins.
                            </MudText>
                        </div>

                        <!-- API key card -->
                        <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:24px;">
                            <MudText Typo="Typo.subtitle1" Style="color:white;font-weight:600;margin-bottom:16px;">
                                <MudIcon Icon="@Icons.Material.Filled.Key" Class="mr-2" Style="vertical-align:middle;" />
                                API Credentials
                            </MudText>
                            <MudGrid Spacing="3">
                                <MudItem xs="12" sm="8">
                                    <MudTextField @bind-Value="_rcApiKey" Label="RevenueCat Secret API Key"
                                                  InputType="InputType.Password"
                                                  Variant="Variant.Outlined"
                                                  HelperText="Found in RevenueCat dashboard → Project Settings → API keys"
                                                  Style="color:white;" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_rcEntitlementId" Label="Entitlement Identifier"
                                                  Variant="Variant.Outlined"
                                                  HelperText="Default: premium" />
                                </MudItem>
                            </MudGrid>
                        </div>

                        <!-- Tier pricing card -->
                        <div style="background:#0d1117;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:24px;">
                            <MudText Typo="Typo.subtitle1" Style="color:white;font-weight:600;margin-bottom:16px;">
                                <MudIcon Icon="@Icons.Material.Filled.Payments" Class="mr-2" Style="vertical-align:middle;" />
                                Subscription Tier Prices
                            </MudText>
                            <MudGrid Spacing="3">
                                @foreach (var tier in _rcTiers)
                                {
                                    <MudItem xs="12" sm="6" lg="3">
                                        <div style="background:#161b27;border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:16px;">
                                            <MudText Typo="Typo.subtitle2" Style="color:white;font-weight:600;margin-bottom:12px;">
                                                @tier.PlanName
                                            </MudText>
                                            <MudNumericField @bind-Value="tier.MonthlyPrice"
                                                             Label="Monthly (£)" Variant="Variant.Outlined"
                                                             Margin="Margin.Dense" Min="0" Class="mb-2" />
                                            <MudNumericField @bind-Value="tier.AnnualPrice"
                                                             Label="Annual (£)" Variant="Variant.Outlined"
                                                             Margin="Margin.Dense" Min="0" />
                                            <MudTextField @bind-Value="tier.RevenueCatProductId"
                                                          Label="RC Product ID" Variant="Variant.Outlined"
                                                          Margin="Margin.Dense" Class="mt-2"
                                                          HelperText="RevenueCat product identifier" />
                                        </div>
                                    </MudItem>
                                }
                            </MudGrid>
                        </div>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   OnClick="SaveRevenueCatConfig">
                            Save RevenueCat Configuration
                        </MudButton>
                    </MudStack>
                </MudTabPanel>
            </MudTabs>
        }
    </div>
</div>

@code {
    private List<TenantListResponse> _tenants = new();
    private bool _loading = true;
    private bool _authorized;
    private string _search = "";
    private Guid? _pendingDeleteId;

    // Users tab
    private List<UserListResponse> _users = new();
    private bool _usersLoading;
    private bool _usersLoaded;
    private string _userSearch = "";
    private string _userRoleFilter = "";
    private Guid? _pendingDeleteUserId;

    private IEnumerable<UserListResponse> FilteredUsers =>
        _users.Where(u =>
            (string.IsNullOrWhiteSpace(_userSearch) ||
             u.Email.Contains(_userSearch, StringComparison.OrdinalIgnoreCase) ||
             u.FullName.Contains(_userSearch, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(_userRoleFilter) ||
             u.RoleName.Equals(_userRoleFilter, StringComparison.OrdinalIgnoreCase)));

    // RevenueCat config
    private string _rcApiKey = "";
    private string _rcEntitlementId = "premium";

    private record RcTierConfig(string PlanName)
    {
        public decimal MonthlyPrice { get; set; }
        public decimal AnnualPrice { get; set; }
        public string RevenueCatProductId { get; set; } = "";
    }

    private List<RcTierConfig> _rcTiers = new()
    {
        new RcTierConfig("Free")       { MonthlyPrice = 0,   AnnualPrice = 0,   RevenueCatProductId = "bookit_free" },
        new RcTierConfig("Starter")    { MonthlyPrice = 19,  AnnualPrice = 15,  RevenueCatProductId = "bookit_starter_monthly" },
        new RcTierConfig("Pro")        { MonthlyPrice = 49,  AnnualPrice = 39,  RevenueCatProductId = "bookit_pro_monthly" },
        new RcTierConfig("Enterprise") { MonthlyPrice = 129, AnnualPrice = 99,  RevenueCatProductId = "bookit_enterprise_monthly" },
    };

    private IEnumerable<TenantListResponse> FilteredTenants =>
        string.IsNullOrWhiteSpace(_search)
            ? _tenants
            : _tenants.Where(t =>
                t.Name.Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                t.Slug.Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                (t.ContactEmail ?? "").Contains(_search, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        // Allow access for SuperAdmin role or unauthenticated (show sign-in prompt)
        _authorized = Auth.IsAuthenticated &&
                      Auth.Role == BookIt.Core.Enums.UserRole.SuperAdmin;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        if (!_authorized)
        {
            _loading = false;
            StateHasChanged();
            return;
        }
        Api.SetToken(Auth.AccessToken);
        _tenants = await Api.GetAllTenantsAsync() ?? new();
        _loading = false;
        StateHasChanged();
    }

    private void OpenSetupPage() => Nav.NavigateTo("/setup");

    private async Task OpenNewTab(string url) =>
        await Js.InvokeVoidAsync("window.open", url, "_blank");

    private async Task ConfirmDeleteTenant(TenantListResponse t)
    {
        _pendingDeleteId = null;
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.SuperAdminDeleteTenantAsync(t.Id);
        if (ok) { _tenants.Remove(t); Snackbar.Add($"Tenant '{t.Name}' deleted.", Severity.Success); StateHasChanged(); }
        else Snackbar.Add("Could not delete tenant.", Severity.Error);
    }

    private async Task CopyTenantId(TenantListResponse t)
    {
        await Js.InvokeVoidAsync("navigator.clipboard.writeText", t.Id.ToString("D"));
        Snackbar.Add($"Tenant ID copied to clipboard.", Severity.Info);
    }

    private void SaveRevenueCatConfig()
    {
        // TODO: persist to AppConfiguration via the API.
        Snackbar.Add("RevenueCat configuration saved (demo — persistence not yet wired to API).", Severity.Info);
    }

    private async Task LoadUsers()
    {
        if (_usersLoaded) return;
        _usersLoading = true;
        StateHasChanged();
        Api.SetToken(Auth.AccessToken);
        _users = await Api.GetAllUsersAsync() ?? new();
        _usersLoaded = true;
        _usersLoading = false;
        StateHasChanged();
    }

    private async Task ChangeUserRole(UserListResponse u, BookIt.Core.Enums.UserRole newRole)
    {
        if (u.Role == newRole) return;
        Api.SetToken(Auth.AccessToken);
        var updated = await Api.UpdateUserRoleAsync(u.Id, new UpdateUserRoleRequest { Role = newRole });
        if (updated != null)
        {
            u.Role = updated.Role;
            u.RoleName = updated.RoleName;
            Snackbar.Add($"Role updated for {u.Email}.", Severity.Success);
            StateHasChanged();
        }
        else
        {
            Snackbar.Add("Could not update role.", Severity.Error);
        }
    }

    private async Task ConfirmDeleteUser(UserListResponse u)
    {
        _pendingDeleteUserId = null;
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.SuperAdminDeleteUserAsync(u.Id);
        if (ok)
        {
            u.IsDeleted = true;
            Snackbar.Add($"User '{u.Email}' disabled.", Severity.Success);
            StateHasChanged();
        }
        else
        {
            Snackbar.Add("Could not disable user.", Severity.Error);
        }
    }
}
