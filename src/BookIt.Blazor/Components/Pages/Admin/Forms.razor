@page "/{tenantSlug}/admin/forms"
@rendermode InteractiveServer
@layout BookIt.UI.Shared.Components.Admin.AdminLayout
@inject BookItApiService Api
@inject BookItAuthState Auth
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Forms — BookIt Admin</PageTitle>

@if (!Auth.IsAuthenticated)
{
    <MudText>Redirecting…</MudText>
}
else
{
    <MudStack>
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
            <div>
                <MudText Typo="Typo.h5" Class="fw-bold">Booking Forms</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Custom pre-booking question forms</MudText>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateForm">New Form</MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (!_forms.Any())
        {
            <MudCard Elevation="1">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Class="py-8">
                        <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Style="opacity:.3;" />
                        <MudText Typo="Typo.body1" Class="fw-medium">No forms yet</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateForm">Create a Form</MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }
        else
        {
            <MudDataGrid T="BookingFormResponse" Items="_forms" Filterable="false" SortMode="SortMode.None">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Form Name" />
                    <PropertyColumn Property="x => x.Fields.Count" Title="Fields" />
                    <TemplateColumn Title="Actions">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                           Href="@($"/{TenantSlug}/admin/forms/builder?formId={context.Item.Id}")" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                           OnClick="@(() => DeleteForm(context.Item))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
    </MudStack>
}

@code {
    [Parameter] public string TenantSlug { get; set; } = "";
    private List<BookingFormResponse> _forms = new();
    private bool _loading = true;

    protected override void OnInitialized()
    {
        if (!Auth.IsAuthenticated)
            Nav.NavigateTo($"/login?returnUrl=/{TenantSlug}/admin/forms");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || !Auth.IsAuthenticated) return;
        Api.SetToken(Auth.AccessToken);
        _forms = await Api.GetFormsAsync(TenantSlug) ?? new();
        _loading = false;
        StateHasChanged();
    }

    private async Task CreateForm()
    {
        Api.SetToken(Auth.AccessToken);
        var form = await Api.CreateFormAsync(TenantSlug, new CreateBookingFormRequest { Name = "New Form" });
        if (form != null)
            Nav.NavigateTo($"/{TenantSlug}/admin/forms/builder?formId={form.Id}");
    }

    private async Task DeleteForm(BookingFormResponse form)
    {
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.DeleteFormAsync(TenantSlug, form.Id);
        if (ok) { _forms.Remove(form); Snackbar.Add("Form deleted.", Severity.Success); }
    }
}
