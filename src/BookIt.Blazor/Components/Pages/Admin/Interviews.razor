@page "/{tenantSlug}/admin/interviews"
@rendermode InteractiveServer
@layout BookIt.UI.Shared.Components.Admin.AdminLayout
@inject BookItApiService Api
@inject BookItAuthState Auth
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@using BookIt.Core.Enums

<PageTitle>Interviews — BookIt Admin</PageTitle>

@if (!Auth.IsAuthenticated)
{
    <MudText>Redirecting…</MudText>
}
else
{
    <MudStack>
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
            <div>
                <MudText Typo="Typo.h5" Class="fw-bold">Interview Scheduling</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Manage slots and candidate invitations</MudText>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@(() => _showCreateSlot = true)">Add Slot</MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" lg="6">
                    <MudCard Elevation="1">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Schedule" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Interview Slots</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (!_slots.Any())
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No slots created yet.</MudText>
                            }
                            else
                            {
                                <MudList T="InterviewSlotResponse" Dense="true">
                                    @foreach (var slot in _slots)
                                    {
                                        <MudListItem T="InterviewSlotResponse" Value="slot">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.body2" Class="fw-semibold">
                                                        @slot.SlotStart.ToString("ddd d MMM, h:mm tt")
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @slot.InterviewerName · @(slot.IsBooked ? "Booked" : "Available")
                                                        @if (slot.VideoConferenceProvider != VideoConferenceProvider.None)
                                                        {
                                                            <span> · @VcLabel(slot.VideoConferenceProvider)</span>
                                                        }
                                                    </MudText>
                                                    @if (!string.IsNullOrEmpty(slot.ConferenceMeetingId))
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            Meeting ID: @slot.ConferenceMeetingId
                                                            @if (!string.IsNullOrEmpty(slot.ConferencePassword)) { <text> · Pass: @slot.ConferencePassword</text> }
                                                        </MudText>
                                                    }
                                                    @if (!string.IsNullOrEmpty(slot.MeetingLink))
                                                    {
                                                        <MudText Typo="Typo.caption">
                                                            <a href="@slot.MeetingLink" target="_blank" style="color:var(--mud-palette-primary);">Join link</a>
                                                        </MudText>
                                                    }
                                                </MudStack>
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                               Color="Color.Error" OnClick="@(() => DeleteSlot(slot))" />
                                            </MudStack>
                                        </MudListItem>
                                        <MudDivider />
                                    }
                                </MudList>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" lg="6">
                    <MudCard Elevation="1">
                        <MudCardHeader>
                            <CardHeaderAvatar><MudIcon Icon="@Icons.Material.Filled.Email" Color="Color.Primary" /></CardHeaderAvatar>
                            <CardHeaderContent><MudText Typo="Typo.h6">Candidate Invitations</MudText></CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (!_invitations.Any())
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No invitations sent yet.</MudText>
                            }
                            else
                            {
                                <MudList T="CandidateInvitationResponse" Dense="true">
                                    @foreach (var inv in _invitations)
                                    {
                                        <MudListItem T="CandidateInvitationResponse" Value="inv">
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2" Class="fw-semibold">@inv.CandidateEmail</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@inv.CandidateName</MudText>
                                            </MudStack>
                                        </MudListItem>
                                        <MudDivider />
                                    }
                                </MudList>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }
    </MudStack>
}

<!-- Create Slot Dialog -->
<MudDialog @bind-Visible="_showCreateSlot" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="font-weight:700;">Add Interview Slot</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="6">
                <MudDatePicker @bind-Date="_slotDate" Label="Slot Date" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTimePicker @bind-Time="_slotTime" Label="Slot Time" Required="true" AmPm="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudNumericField @bind-Value="_durationMinutes" Label="Duration (minutes)" Min="15" Max="480" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_interviewerName" Label="Interviewer Name" Required="true" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_location" Label="Physical Location (optional)"
                              HelperText="e.g. Room 3A, Head Office, etc." />
            </MudItem>

            <MudItem xs="12">
                <MudDivider />
                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2" Style="font-weight:700;">
                    <MudIcon Icon="@Icons.Material.Filled.VideoCall" Size="Size.Small" Style="vertical-align:middle;margin-right:4px;" />
                    Video Conference
                </MudText>
            </MudItem>

            <MudItem xs="12">
                <MudSelect @bind-Value="_vcProvider" Label="Video Conference Provider">
                    @foreach (VideoConferenceProvider p in Enum.GetValues<VideoConferenceProvider>())
                    {
                        <MudSelectItem Value="p">@VcLabel(p)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            @if (_vcProvider != VideoConferenceProvider.None)
            {
                <MudItem xs="12">
                    <MudTextField @bind-Value="_meetingLink" Label="Meeting / Join URL"
                                  HelperText="The URL candidates will use to join the video call"
                                  InputType="InputType.Url" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_conferenceMeetingId" Label="Meeting ID" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_conferencePassword" Label="Meeting Password / PIN" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_conferenceHostUrl" Label="Host URL (admin only)" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_conferenceDialIn" Label="Dial-In Number (optional)"
                                  HelperText="Phone number for candidates who can't join by video" />
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showCreateSlot = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateSlot" Disabled="_saving">
            @(_saving ? "Saving…" : "Create Slot")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public string TenantSlug { get; set; } = "";
    private List<InterviewSlotResponse> _slots = new();
    private List<CandidateInvitationResponse> _invitations = new();
    private bool _loading = true;

    private bool _showCreateSlot;
    private bool _saving;
    private DateTime? _slotDate = DateTime.Today.AddDays(1);
    private TimeSpan? _slotTime = new TimeSpan(10, 0, 0);
    private int _durationMinutes = 60;
    private string _interviewerName = "";
    private string? _location;
    private string? _meetingLink;
    private VideoConferenceProvider _vcProvider = VideoConferenceProvider.None;
    private string? _conferenceMeetingId;
    private string? _conferencePassword;
    private string? _conferenceHostUrl;
    private string? _conferenceDialIn;

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseOnEscapeKey = true
    };

    protected override void OnInitialized()
    {
        if (!Auth.IsAuthenticated)
            Nav.NavigateTo($"/login?returnUrl=/{TenantSlug}/admin/interviews");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || !Auth.IsAuthenticated) return;
        Api.SetToken(Auth.AccessToken);
        _slots = await Api.GetInterviewSlotsAsync(TenantSlug) ?? new();
        _invitations = await Api.GetInterviewInvitationsAsync(TenantSlug) ?? new();
        _loading = false;
        StateHasChanged();
    }

    private async Task CreateSlot()
    {
        if (_slotDate == null || _slotTime == null || string.IsNullOrWhiteSpace(_interviewerName))
        {
            Snackbar.Add("Slot date, time, and interviewer name are required.", Severity.Warning);
            return;
        }
        _saving = true;
        Api.SetToken(Auth.AccessToken);
        var slotStart = _slotDate.Value.Date + _slotTime.Value;
        var req = new CreateInterviewSlotRequest
        {
            InterviewerName = _interviewerName,
            SlotStart = slotStart,
            DurationMinutes = _durationMinutes,
            Location = _location,
            MeetingLink = _vcProvider != VideoConferenceProvider.None ? _meetingLink : null,
            VideoConferenceProvider = _vcProvider,
            ConferenceMeetingId = _conferenceMeetingId,
            ConferencePassword = _conferencePassword,
            ConferenceHostUrl = _conferenceHostUrl,
            ConferenceDialIn = _conferenceDialIn
        };
        var created = await Api.CreateInterviewSlotAsync(TenantSlug, req);
        if (created != null)
        {
            _slots.Insert(0, created);
            _showCreateSlot = false;
            ResetSlotForm();
            Snackbar.Add("Slot created.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to create slot.", Severity.Error);
        }
        _saving = false;
    }

    private void ResetSlotForm()
    {
        _slotDate = DateTime.Today.AddDays(1);
        _slotTime = new TimeSpan(10, 0, 0);
        _durationMinutes = 60;
        _interviewerName = "";
        _location = null;
        _meetingLink = null;
        _vcProvider = VideoConferenceProvider.None;
        _conferenceMeetingId = null;
        _conferencePassword = null;
        _conferenceHostUrl = null;
        _conferenceDialIn = null;
    }

    private async Task DeleteSlot(InterviewSlotResponse slot)
    {
        Api.SetToken(Auth.AccessToken);
        await Api.DeleteInterviewSlotAsync(TenantSlug, slot.Id);
        _slots.Remove(slot);
        Snackbar.Add("Slot removed.", Severity.Success);
    }

    private static string VcLabel(VideoConferenceProvider p) => p switch
    {
        VideoConferenceProvider.MicrosoftTeams => "Microsoft Teams",
        VideoConferenceProvider.Zoom => "Zoom",
        VideoConferenceProvider.GoogleMeet => "Google Meet",
        VideoConferenceProvider.Webex => "Cisco Webex",
        VideoConferenceProvider.GoToMeeting => "GoTo Meeting",
        VideoConferenceProvider.Jitsi => "Jitsi Meet",
        VideoConferenceProvider.Whereby => "Whereby",
        VideoConferenceProvider.Other => "Other",
        _ => "None"
    };
}

