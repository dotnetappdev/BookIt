@page "/{tenantSlug}/admin/classes"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@layout BookIt.UI.Shared.Components.Admin.AdminLayout
@inject BookItApiService Api
@inject BookItAuthState Auth
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Classes &amp; Group Sessions — BookIt Admin</PageTitle>

@if (!Auth.IsAuthenticated)
{
    <MudText>Redirecting…</MudText>
}
else
{
    <MudStack>
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
            <div>
                <MudText Typo="Typo.h5" Class="fw-bold">Classes &amp; Group Sessions</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Schedule classes and sessions — assign one or more instructors</MudText>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AddCircle"
                       OnClick="OpenAddDialog">New Class</MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (!_sessions.Any())
        {
            <MudCard Elevation="1">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Class="py-8">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Large" Style="opacity:.3;" />
                        <MudText Typo="Typo.body1" Class="fw-medium">No classes scheduled</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Create group sessions that multiple customers can book into.</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddDialog">Schedule Your First Class</MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }
        else
        {
            <MudDataGrid T="ClassSessionResponse" Items="_sessions"
                         Filterable="true" FilterMode="DataGridFilterMode.ColumnFilterRow"
                         SortMode="SortMode.Multiple"
                         RowsPerPage="20"
                         Hover="true" Dense="false">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Class" />
                    <PropertyColumn Property="x => x.ServiceName" Title="Service" />
                    <TemplateColumn Title="Date" Sortable="true" Filterable="false">
                        <CellTemplate>
                            <MudText Typo="Typo.body2">@context.Item.SessionDate.ToString("d MMM yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.StartTime</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.DurationMinutes" Title="Duration (min)" />
                    <TemplateColumn Title="Capacity" Sortable="false" Filterable="false">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small"
                                     Color="@(context.Item.CurrentBookings >= context.Item.MaxCapacity ? Color.Error : Color.Default)"
                                     Variant="Variant.Outlined">
                                @context.Item.CurrentBookings / @context.Item.MaxCapacity
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Price" Sortable="false" Filterable="false">
                        <CellTemplate>
                            <MudText Typo="Typo.body2">@(context.Item.Price == 0 ? "Free" : $"£{context.Item.Price:0.00}")</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Instructors" Sortable="false" Filterable="false">
                        <CellTemplate>
                            @{ var names = InstructorNames(context.Item.InstructorIds); }
                            @if (names.Any())
                            {
                                <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                                    @foreach (var n in names)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@n</MudChip>
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Tertiary">—</MudText>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.StatusLabel" Title="Status" />
                    <PropertyColumn Property="x => x.Location" Title="Location" />
                    <TemplateColumn Title="" Sortable="false" Filterable="false">
                        <CellTemplate>
                            <MudStack Row="true" Spacing="0">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                               OnClick="@(() => OpenEditDialog(context.Item))" />
                                @if (context.Item.Status != SessionStatus.Cancelled)
                                {
                                    @if (_pendingCancelId == context.Item.Id)
                                    {
                                        <MudButton Size="Size.Small" Color="Color.Error" Variant="Variant.Filled"
                                                   OnClick="@(() => ConfirmCancel(context.Item))">Cancel?</MudButton>
                                        <MudButton Size="Size.Small" OnClick="@(() => _pendingCancelId = null)">No</MudButton>
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error"
                                                       OnClick="@(() => _pendingCancelId = context.Item.Id)" />
                                    }
                                }
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="ClassSessionResponse" />
                </PagerContent>
            </MudDataGrid>
        }
    </MudStack>
}

<MudDialog @bind-Visible="_dialogOpen" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_editSession == null ? "New Class / Session" : "Edit Class")</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_mudForm" @bind-IsValid="_formValid">
        <MudGrid Spacing="2">
            <MudItem xs="8">
                <MudTextField @bind-Value="_form.Name" Label="Class Name" Required="true"
                              RequiredError="Class name is required." MaxLength="200" Immediate="true"
                              Validation="@((string v) => string.IsNullOrWhiteSpace(v) ? "Class name is required." : null)"
                              Placeholder="e.g. Morning Yoga, Spin Class" />
            </MudItem>
            <MudItem xs="4">
                <MudSelect @bind-Value="_form.ServiceId" Label="Service" Required="true">
                    @foreach (var svc in _services)
                    {
                        <MudSelectItem Value="@svc.Id">@svc.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_form.Description" Label="Description" Lines="2"
                              MaxLength="2000"
                              Placeholder="Brief description of the class…" />
            </MudItem>
            <MudItem xs="4">
                <MudDatePicker @bind-Date="_form.SessionDate" Label="Date" Required="true" />
            </MudItem>
            <MudItem xs="4">
                <MudTimePicker @bind-Time="_form.StartTime" Label="Start Time" Required="true" AmPm="false" />
            </MudItem>
            <MudItem xs="4">
                <MudNumericField @bind-Value="_form.DurationMinutes" Label="Duration (minutes)" Min="5" Max="1440" />
            </MudItem>
            <MudItem xs="4">
                <MudNumericField @bind-Value="_form.MaxCapacity" Label="Max Capacity" Min="1" Max="10000" />
            </MudItem>
            <MudItem xs="4">
                <MudNumericField @bind-Value="_form.Price" Label="Price (£)" Min="0" Step="0.01M" Format="F2" />
            </MudItem>
            <MudItem xs="4">
                <MudTextField @bind-Value="_form.Location" Label="Location / Room" MaxLength="200"
                              Placeholder="e.g. Studio 1, Pool" />
            </MudItem>
            @if (_staff.Any())
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Instructors / Staff</MudText>
                    <MudGrid Spacing="1">
                        @foreach (var sm in _staff.Where(x => x.IsActive))
                        {
                            <MudItem xs="6" sm="4">
                                <MudCheckBox Value="@_form.InstructorChecked.GetValueOrDefault(sm.Id.ToString())"
                                             ValueChanged="@((bool v) => _form.InstructorChecked[sm.Id.ToString()] = v)"
                                             Color="Color.Primary" Label="@sm.FullName" Dense="true" />
                            </MudItem>
                        }
                    </MudGrid>
                </MudItem>
            }
        </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSession" Disabled="_saving">
            @(_saving ? "Saving…" : (_editSession == null ? "Create Class" : "Save Changes"))
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public string TenantSlug { get; set; } = "";

    private List<ClassSessionResponse> _sessions = new();
    private List<StaffResponse> _staff = new();
    private List<ServiceResponse> _services = new();
    private bool _loading = true;
    private Guid? _pendingCancelId;

    private bool _dialogOpen;
    private bool _saving;
    private bool _formValid;
    private MudForm? _mudForm;
    private ClassSessionResponse? _editSession;
    private ClassFormModel _form = new();

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseOnEscapeKey = true
    };

    protected override void OnInitialized()
    {
        if (!Auth.IsAuthenticated)
            Nav.NavigateTo($"/login?returnUrl=/{TenantSlug}/admin/classes");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || !Auth.IsAuthenticated) return;
        Api.SetToken(Auth.AccessToken);
        var sessionsTask = Api.GetClassSessionsAsync(TenantSlug);
        var staffTask = Api.GetAllStaffAsync(TenantSlug);
        var servicesTask = Api.GetServicesAsync(TenantSlug);
        await Task.WhenAll(sessionsTask, staffTask, servicesTask);
        _sessions = sessionsTask.Result ?? new();
        _staff = staffTask.Result ?? new();
        _services = servicesTask.Result ?? new();
        _loading = false;
        StateHasChanged();
    }

    private void OpenAddDialog()
    {
        _editSession = null;
        _form = new ClassFormModel();
        foreach (var s in _staff.Where(x => x.IsActive))
            _form.InstructorChecked[s.Id.ToString()] = false;
        _dialogOpen = true;
    }

    private void OpenEditDialog(ClassSessionResponse s)
    {
        _editSession = s;
        _form = new ClassFormModel
        {
            Name = s.Name,
            Description = s.Description,
            ServiceId = s.ServiceId ?? Guid.Empty,
            SessionDate = s.SessionDate,
            StartTime = TimeSpan.TryParse(s.StartTime, out var t) ? t : TimeSpan.Zero,
            DurationMinutes = s.DurationMinutes,
            MaxCapacity = s.MaxCapacity,
            Price = s.Price,
            Location = s.Location
        };
        foreach (var st in _staff.Where(x => x.IsActive))
            _form.InstructorChecked[st.Id.ToString()] = s.InstructorIds.Contains(st.Id.ToString());
        _dialogOpen = true;
    }

    private void CloseDialog() => _dialogOpen = false;

    private async Task SaveSession()
    {
        if (_mudForm != null) await _mudForm.Validate();
        if (!_formValid) return;
        if (_form.SessionDate == null)
        {
            Snackbar.Add("Session date is required.", Severity.Warning);
            return;
        }
        // Sanitize
        _form.Name = _form.Name.Trim();
        _saving = true;
        Api.SetToken(Auth.AccessToken);

        var instructorIds = _form.InstructorChecked
            .Where(kv => kv.Value)
            .Select(kv => kv.Key)
            .ToList();

        var startStr = _form.StartTime?.ToString("HH\\:mm") ?? "09:00";

        if (_editSession == null)
        {
            var req = new CreateClassSessionRequest
            {
                ServiceId = _form.ServiceId,
                Name = _form.Name,
                Description = _form.Description,
                SessionDate = _form.SessionDate!.Value,
                StartTime = startStr,
                DurationMinutes = _form.DurationMinutes,
                MaxCapacity = _form.MaxCapacity,
                Price = _form.Price,
                Location = _form.Location,
                InstructorIds = instructorIds
            };
            var created = await Api.CreateClassSessionAsync(TenantSlug, req);
            if (created != null) { _sessions.Insert(0, created); Snackbar.Add("Class created.", Severity.Success); }
            else Snackbar.Add("Failed to create class.", Severity.Error);
        }
        else
        {
            var req = new UpdateClassSessionRequest
            {
                ServiceId = _form.ServiceId == Guid.Empty ? null : _form.ServiceId,
                Name = _form.Name,
                Description = _form.Description,
                SessionDate = _form.SessionDate,
                StartTime = startStr,
                DurationMinutes = _form.DurationMinutes,
                MaxCapacity = _form.MaxCapacity,
                Price = _form.Price,
                Location = _form.Location,
                InstructorIds = instructorIds
            };
            var updated = await Api.UpdateClassSessionAsync(TenantSlug, _editSession.Id, req);
            if (updated != null)
            {
                var idx = _sessions.IndexOf(_editSession);
                if (idx >= 0) _sessions[idx] = updated;
                Snackbar.Add("Class updated.", Severity.Success);
            }
            else Snackbar.Add("Failed to update class.", Severity.Error);
        }

        _saving = false;
        _dialogOpen = false;
        StateHasChanged();
    }

    private async Task ConfirmCancel(ClassSessionResponse s)
    {
        _pendingCancelId = null;
        Api.SetToken(Auth.AccessToken);
        var ok = await Api.CancelClassSessionAsync(TenantSlug, s.Id);
        if (ok)
        {
            _sessions = await Api.GetClassSessionsAsync(TenantSlug) ?? _sessions;
            Snackbar.Add("Class cancelled.", Severity.Success);
            StateHasChanged();
        }
        else Snackbar.Add("Failed to cancel class.", Severity.Error);
    }

    private List<string> InstructorNames(List<string> ids) =>
        _staff.Where(s => ids.Contains(s.Id.ToString())).Select(s => s.FullName).ToList();

    private class ClassFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public Guid ServiceId { get; set; }
        public DateTime? SessionDate { get; set; } = DateTime.Today.AddDays(1);
        public TimeSpan? StartTime { get; set; } = TimeSpan.FromHours(9);
        public int DurationMinutes { get; set; } = 60;
        public int MaxCapacity { get; set; } = 20;
        public decimal Price { get; set; }
        public string? Location { get; set; }
        public Dictionary<string, bool> InstructorChecked { get; set; } = new();
    }
}
