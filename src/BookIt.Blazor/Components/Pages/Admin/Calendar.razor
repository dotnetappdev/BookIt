@page "/{tenantSlug}/admin/calendar"
@rendermode InteractiveServer
@layout BookIt.UI.Shared.Components.Admin.AdminLayout
@inject BookItApiService Api
@inject BookItAuthState Auth
@inject NavigationManager Nav

<PageTitle>Calendar — BookIt Admin</PageTitle>

@if (!Auth.IsAuthenticated)
{
    <MudText>Redirecting…</MudText>
}
else
{
    <BookIt.UI.Shared.Components.Admin.CalendarView
        Appointments="@_appointments"
        InitialView="week"
        OnRangeChanged="@HandleRangeChanged" />
}

@code {
    [Parameter] public string TenantSlug { get; set; } = "";

    private List<AppointmentResponse> _appointments = new();

    protected override void OnInitialized()
    {
        if (!Auth.IsAuthenticated)
            Nav.NavigateTo($"/login?returnUrl=/{TenantSlug}/admin/calendar");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || !Auth.IsAuthenticated) return;
        // Load the current week on first render
        var monday = DateTime.Today.AddDays(-(((int)DateTime.Today.DayOfWeek + 6) % 7));
        await LoadAsync(monday, monday.AddDays(7));
    }

    private async Task HandleRangeChanged((DateTime From, DateTime To) range)
    {
        await LoadAsync(range.From, range.To);
    }

    private async Task LoadAsync(DateTime from, DateTime to)
    {
        Api.SetToken(Auth.AccessToken);
        _appointments = await Api.GetAppointmentsAsync(TenantSlug, from, to);
        StateHasChanged();
    }
}
