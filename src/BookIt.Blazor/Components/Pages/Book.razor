@page "/{tenantSlug}/book"
@rendermode InteractiveServer
@layout BookIt.Blazor.Components.Layout.MainLayout
@inject BookItApiService Api
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IJSRuntime Js

<PageTitle>Book an Appointment</PageTitle>

<style>
    .book-page {
        min-height: calc(100vh - 64px);
        background: var(--mud-palette-background);
        padding: 2rem 1rem 4rem;
    }
    .book-container { max-width: 760px; margin: 0 auto; }
    .step-indicator {
        display: flex; align-items: center; justify-content: center;
        gap: 0; margin-bottom: 2.5rem;
    }
    .step-dot {
        width: 34px; height: 34px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: .82rem; font-weight: 700; transition: .2s;
        border: 2px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-secondary);
    }
    .step-dot.active {
        border-color: var(--mud-palette-primary);
        background: var(--mud-palette-primary); color: #fff;
    }
    .step-dot.done {
        border-color: var(--mud-palette-success);
        background: var(--mud-palette-success); color: #fff;
    }
    .step-line {
        flex: 1; height: 2px; max-width: 80px;
        background: var(--mud-palette-divider); transition: .2s;
    }
    .step-line.done { background: var(--mud-palette-success); }
    .service-card {
        border: 2px solid var(--mud-palette-divider);
        border-radius: 12px; padding: .9rem 1.1rem;
        cursor: pointer; transition: .15s;
        background: var(--mud-palette-surface);
    }
    .service-card:hover { border-color: var(--mud-palette-primary); }
    .service-card.selected {
        border-color: var(--mud-palette-primary);
        background: rgba(var(--mud-palette-primary-rgb),.06);
    }
    .slot-chip {
        padding: .6rem .8rem; border-radius: 10px; cursor: pointer;
        text-align: center; line-height: 1.2;
        border: 1.5px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface); transition: .15s;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        min-height: 58px;
    }
    .slot-chip:hover { border-color: var(--mud-palette-primary); box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    .slot-chip.selected {
        background: var(--mud-palette-primary);
        border-color: var(--mud-palette-primary); color: #fff;
    }
    .slot-chip .slot-time { font-size: .88rem; font-weight: 700; }
    .slot-chip .slot-dur { font-size: .72rem; opacity: .75; margin-top: 2px; }
    .confirm-card {
        border-radius: 14px; overflow: hidden;
        border: 1.5px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface);
    }
    .confirm-header {
        background: linear-gradient(135deg,var(--mud-palette-primary),var(--mud-palette-secondary));
        padding: 1.5rem; color: #fff;
    }
    .upload-zone {
        border: 2px dashed var(--mud-palette-divider); border-radius: 10px;
        padding: 1.5rem; text-align: center; cursor: pointer; transition: .15s;
    }
    .upload-zone:hover { border-color: var(--mud-palette-primary); }
    .amenity-chip {
        display: inline-flex; align-items: center; gap: .3rem;
        padding: .3rem .7rem; border-radius: 99px; font-size: .78rem; font-weight: 500;
        background: rgba(var(--mud-palette-primary-rgb),.1);
        color: var(--mud-palette-primary); margin: .2rem;
    }
</style>

@if (_tenant != null && (!string.IsNullOrEmpty(_tenant.PrimaryColor) || _tenant.Theme != TenantTheme.Indigo))
{
    <style>
        :root {
            --mud-palette-primary: @EffectivePrimaryColor() !important;
        }
    </style>
}

<div class="book-page">
    <div class="book-container">

        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-16">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                <MudText Color="Color.Secondary">Loading booking page…</MudText>
            </MudStack>
        }
        else if (_tenant == null)
        {
            <MudAlert Severity="Severity.Error">Business not found.</MudAlert>
        }
        else if (_confirmed)
        {
            <!-- Confirmation screen -->
            <MudStack AlignItems="AlignItems.Center" Class="py-8">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="font-size:4rem;color:var(--mud-palette-success);" />
                <MudText Typo="Typo.h4" Class="fw-bold mt-2">Booking Confirmed!</MudText>
                <MudText Color="Color.Secondary" Class="text-center">
                    You'll receive a confirmation at <strong>@_customerEmail</strong>
                </MudText>

                @if (_confirmedAppointment != null)
                {
                    <MudCard Elevation="1" Class="mt-4" Style="width:100%;max-width:520px;">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Color="Color.Secondary">Service</MudText>
                                    <MudText Class="fw-medium">@(_selectedService?.Name ?? "—")</MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Color="Color.Secondary">Date & Time</MudText>
                                    <MudText Class="fw-medium">@_selectedSlot?.ToString("ddd d MMM, h:mm tt")</MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Color="Color.Secondary">Duration</MudText>
                                    <MudText Class="fw-medium">@_requestedDurationMinutes min@(IsCustomDuration ? " (custom)" : "")</MudText>
                                </MudStack>
                                @if (_selectedService != null && _selectedService.Price > 0)
                                {
                                    <MudDivider />
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Class="fw-semibold">Total</MudText>
                                        <MudText Class="fw-semibold" Color="Color.Primary">
                                            @CurrencySymbol()@(_selectedService.Price.ToString("0.00"))
                                        </MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }

                <MudButton Variant="Variant.Outlined" Class="mt-4" Href="@($"/{TenantSlug}/book")">
                    Book Another
                </MudButton>
            </MudStack>
        }
        else
        {
            <!-- Tenant header -->
            <div class="mb-4">
                @if (!string.IsNullOrEmpty(_tenant.BannerImageUrl))
                {
                    <div style="border-radius:14px;overflow:hidden;margin-bottom:1.25rem;max-height:220px;">
                        <img src="@_tenant.BannerImageUrl" alt="@_tenant.Name banner"
                             style="width:100%;height:220px;object-fit:cover;display:block;" />
                    </div>
                }
                <MudStack AlignItems="AlignItems.Center">
                    @if (!string.IsNullOrEmpty(_tenant.LogoUrl))
                    {
                        <img src="@_tenant.LogoUrl" alt="@_tenant.Name" style="height:56px;object-fit:contain;" />
                    }
                    <MudText Typo="Typo.h5" Class="fw-bold">@_tenant.Name</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @(!string.IsNullOrWhiteSpace(_tenant.BookingPageTitle) ? _tenant.BookingPageTitle : "Online Booking")
                    </MudText>
                </MudStack>
            </div>

            <!-- Step indicator -->
            <div class="step-indicator">
                <div class="step-dot @StepClass(1)">1</div>
                <div class="step-line @(_step > 1 ? "done" : "")"></div>
                <div class="step-dot @StepClass(2)">2</div>
                <div class="step-line @(_step > 2 ? "done" : "")"></div>
                <div class="step-dot @StepClass(3)">3</div>
                <div class="step-line @(_step > 3 ? "done" : "")"></div>
                <div class="step-dot @StepClass(4)">4</div>
            </div>

            <!-- Step 1: Choose service -->
            @if (_step == 1)
            {
                <MudText Typo="Typo.h6" Class="fw-bold mb-1">Choose a Service</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">Select the service you'd like to book</MudText>
                @if (!_services.Any())
                {
                    <MudAlert Severity="Severity.Info">No services are available for online booking at this time.</MudAlert>
                }
                else
                {
                    <MudStack Spacing="2">
                        @foreach (var svc in _services.Where(s => s.AllowOnlineBooking))
                        {
                            var s = svc;
                            <div class="service-card @(_selectedService?.Id == s.Id ? "selected" : "")"
                                 @onclick="@(() => SelectService(s))">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Spacing="0">
                                        <MudText Class="fw-semibold">@s.Name</MudText>
                                        @if (!string.IsNullOrEmpty(s.Description))
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">@s.Description</MudText>
                                        }
                                        <MudStack Row="true" Spacing="2" Class="mt-1">
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Label="true">
                                                @s.DurationMinutes min
                                            </MudChip>
                                            @if (s.Price > 0)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text" Label="true">
                                                    @CurrencySymbol()@s.Price.ToString("0.00")
                                                </MudChip>
                                            }
                                            else
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text" Label="true">Free</MudChip>
                                            }
                                        </MudStack>
                                    </MudStack>
                                    @if (_selectedService?.Id == s.Id)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" />
                                    }
                                </MudStack>
                            </div>
                        }
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_selectedService == null"
                                   OnClick="@(() => _step = 2)" EndIcon="@Icons.Material.Filled.ArrowForward">
                            Next: Pick a Time
                        </MudButton>
                    </MudStack>
                }
            }

            <!-- Step 2: Pick date & slot -->
            @if (_step == 2)
            {
                <MudText Typo="Typo.h6" Class="fw-bold mb-1">Pick a Date & Time</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    @_selectedService?.Name · @_selectedService?.DurationMinutes min
                </MudText>
                <!-- Duration selector -->
                <MudPaper Elevation="0" Class="mb-3 pa-3" Style="border:1.5px solid var(--mud-palette-divider);border-radius:10px;">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Wrap="Wrap.Wrap">
                        <MudIcon Icon="@Icons.Material.Filled.AccessTime" Color="Color.Primary" />
                        <MudText Typo="Typo.body2" Class="fw-medium">Appointment Duration</MudText>
                        <MudStack Row="true" Spacing="1">
                            @foreach (var mins in DurationOptions())
                            {
                                var m = mins;
                                <MudButton Variant="@(_requestedDurationMinutes == m ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Primary" Size="Size.Small"
                                           OnClick="@(() => SetDuration(m))">@m min</MudButton>
                            }
                        </MudStack>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Need more time? Select a longer slot.
                        </MudText>
                    </MudStack>
                </MudPaper>
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudDatePicker Date="_pickedDate" Label="Select Date"
                                       Variant="Variant.Outlined" MinDate="DateTime.Today"
                                       PickerVariant="PickerVariant.Static"
                                       DateChanged="@((DateTime? d) => OnDateChanged(d))" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        @if (_slotsLoading)
                        {
                            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                        }
                        else if (_pickedDate.HasValue && !_availableSlots.Any())
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">No availability on this date. Please try another.</MudAlert>
                        }
                        else if (_availableSlots.Any())
                        {
                            <MudText Typo="Typo.subtitle2" Class="fw-semibold mb-2">Available times</MudText>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;">
                                @foreach (var slot in _availableSlots)
                                {
                                    var s = slot;
                                    <div class="slot-chip @(_selectedSlot == s ? "selected" : "")"
                                         @onclick="@(() => _selectedSlot = s)">
                                        <span class="slot-time">@s.ToString("h:mm tt")</span>
                                        <span class="slot-dur">@_requestedDurationMinutes min</span>
                                    </div>
                                }
                            </div>
                        }
                    </MudItem>
                </MudGrid>
                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" OnClick="@(() => _step = 1)"
                               StartIcon="@Icons.Material.Filled.ArrowBack">Back</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               Disabled="!_selectedSlot.HasValue" OnClick="@(() => _step = 3)"
                               EndIcon="@Icons.Material.Filled.ArrowForward">Next: Your Details</MudButton>
                </MudStack>
            }

            <!-- Step 3: Customer details + custom form fields -->
            @if (_step == 3)
            {
                <MudText Typo="Typo.h6" Class="fw-bold mb-1">Your Details</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    @_selectedService?.Name — @_selectedSlot?.ToString("dddd d MMMM, h:mm tt")
                </MudText>

                <MudForm @ref="_detailsForm">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_customerName" Label="Full Name" Required="true"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_customerEmail" Label="Email Address" Required="true"
                                          InputType="InputType.Email" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_customerPhone" Label="Phone (optional)"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_customerNotes" Label="Notes (optional)"
                                          Variant="Variant.Outlined" Lines="2" />
                        </MudItem>

                        <!-- CV upload for interview bookings -->
                        @if (_tenant.BusinessType == BusinessType.Recruitment)
                        {
                            <MudItem xs="12">
                                <MudText Typo="Typo.subtitle2" Class="fw-semibold mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" Class="me-1" />
                                    Upload CV / Résumé
                                </MudText>
                                <div class="upload-zone" @onclick="TriggerFileInput">
                                    @if (_cvFileName != null)
                                    {
                                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" />
                                            <MudText Class="fw-medium">@_cvFileName</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Click to replace</MudText>
                                        </MudStack>
                                    }
                                    else
                                    {
                                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Style="font-size:2rem;" Color="Color.Primary" />
                                            <MudText Class="fw-medium">Click to upload CV</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                Accepted: @(_tenant.AllowedFileExtensions ?? ".pdf, .doc, .docx")
                                            </MudText>
                                        </MudStack>
                                    }
                                </div>
                                <InputFile id="cvFileInput" OnChange="OnCvFileChanged"
                                           style="display:none;" accept="@(_tenant.AllowedFileExtensions ?? ".pdf,.doc,.docx")" />
                            </MudItem>
                        }

                        <!-- Custom form fields from form builder -->
                        @if (_bookingForm != null && _bookingForm.Fields.Any())
                        {
                            <MudItem xs="12">
                                <MudDivider Class="my-2" />
                                @if (!string.IsNullOrEmpty(_bookingForm.WelcomeMessage))
                                {
                                    <MudAlert Severity="Severity.Info" Class="mb-3">@_bookingForm.WelcomeMessage</MudAlert>
                                }
                            </MudItem>
                            @foreach (var field in _bookingForm.Fields.Where(f => f.IsActive).OrderBy(f => f.SortOrder))
                            {
                                var f = field;
                                <MudItem xs="12" sm="@(f.FieldType == BookingFormFieldType.Heading || f.FieldType == BookingFormFieldType.Paragraph || f.FieldType == BookingFormFieldType.TextArea || f.FieldType == BookingFormFieldType.ServicesList ? 12 : 6)">
                                    @switch (f.FieldType)
                                    {
                                        case BookingFormFieldType.Heading:
                                            <MudText Typo="Typo.subtitle1" Class="fw-bold mt-1">@f.Label</MudText>
                                            break;
                                        case BookingFormFieldType.Paragraph:
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">@f.Label</MudText>
                                            break;
                                        case BookingFormFieldType.TextArea:
                                            <MudTextField Label="@f.Label" Variant="Variant.Outlined" Lines="3"
                                                          Placeholder="@f.Placeholder" Required="@f.IsRequired"
                                                          Value="@GetFieldValue(f.FieldName)"
                                                          ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))" />
                                            break;
                                        case BookingFormFieldType.Email:
                                            <MudTextField Label="@f.Label" Variant="Variant.Outlined"
                                                          InputType="InputType.Email" Placeholder="@f.Placeholder"
                                                          Required="@f.IsRequired"
                                                          Value="@GetFieldValue(f.FieldName)"
                                                          ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))" />
                                            break;
                                        case BookingFormFieldType.Phone:
                                            <MudTextField Label="@f.Label" Variant="Variant.Outlined"
                                                          InputType="InputType.Telephone" Placeholder="@f.Placeholder"
                                                          Required="@f.IsRequired"
                                                          Value="@GetFieldValue(f.FieldName)"
                                                          ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))" />
                                            break;
                                        case BookingFormFieldType.Number:
                                            <MudTextField Label="@f.Label" Variant="Variant.Outlined"
                                                          InputType="InputType.Number" Placeholder="@f.Placeholder"
                                                          Required="@f.IsRequired"
                                                          Value="@GetFieldValue(f.FieldName)"
                                                          ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))" />
                                            break;
                                        case BookingFormFieldType.Date:
                                            <MudTextField Label="@f.Label" Variant="Variant.Outlined"
                                                          InputType="InputType.Date" Required="@f.IsRequired"
                                                          Value="@GetFieldValue(f.FieldName)"
                                                          ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))" />
                                            break;
                                        case BookingFormFieldType.Select:
                                            <MudSelect T="string" Label="@f.Label" Variant="Variant.Outlined"
                                                       Required="@f.IsRequired"
                                                       Value="@GetFieldValue(f.FieldName)"
                                                       ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))">
                                                @foreach (var opt in f.Options)
                                                {
                                                    <MudSelectItem T="string" Value="opt">@opt</MudSelectItem>
                                                }
                                            </MudSelect>
                                            break;
                                        case BookingFormFieldType.Radio:
                                            <MudStack>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@f.Label @(f.IsRequired ? "*" : "")</MudText>
                                                <MudRadioGroup T="string" Value="@GetFieldValue(f.FieldName)"
                                                               ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))">
                                                    @foreach (var opt in f.Options)
                                                    {
                                                        <MudRadio T="string" Value="opt">@opt</MudRadio>
                                                    }
                                                </MudRadioGroup>
                                            </MudStack>
                                            break;
                                        case BookingFormFieldType.Checkbox:
                                            <MudStack>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@f.Label @(f.IsRequired ? "*" : "")</MudText>
                                                @foreach (var opt in f.Options)
                                                {
                                                    var o = opt;
                                                    <MudCheckBox T="bool" Label="@o"
                                                                 Value="@IsCheckboxChecked(f.FieldName, o)"
                                                                 ValueChanged="@((bool v) => ToggleCheckbox(f.FieldName, o, v))" />
                                                }
                                            </MudStack>
                                            break;
                                        case BookingFormFieldType.Rating:
                                            <MudStack>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@f.Label</MudText>
                                                <MudRating SelectedValue="@(int.TryParse(GetFieldValue(f.FieldName), out var r) ? r : 0)"
                                                           SelectedValueChanged="@((int v) => SetFieldValue(f.FieldName, v.ToString()))" />
                                            </MudStack>
                                            break;
                                        case BookingFormFieldType.FileUpload:
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@f.Label @(f.IsRequired ? "*" : "")</MudText>
                                                <div class="upload-zone">
                                                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Primary" />
                                                    <MudText Typo="Typo.caption">Click to upload file</MudText>
                                                </div>
                                            </MudStack>
                                            break;
                                        case BookingFormFieldType.ServicesList:
                                            <MudStack Spacing="1">
                                                @if (!string.IsNullOrWhiteSpace(f.Label))
                                                {
                                                    <MudText Typo="Typo.subtitle1" Class="fw-bold">@f.Label</MudText>
                                                }
                                                <MudPaper Outlined="true" Style="border-radius:10px;overflow:hidden;">
                                                    @if (!_services.Any())
                                                    {
                                                        <div Style="padding:1.25rem;text-align:center;opacity:.55;">
                                                            <MudText Typo="Typo.body2">No services available yet.</MudText>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        @foreach (var svc in _services.Where(s => s.AllowOnlineBooking))
                                                        {
                                                            <div Style="padding:.75rem 1rem;border-bottom:1px solid var(--mud-palette-divider);display:flex;align-items:center;gap:.75rem;">
                                                                <div Style="width:36px;height:36px;border-radius:8px;background:rgba(var(--mud-palette-primary-rgb),.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Spa" Size="Size.Small" Color="Color.Primary" />
                                                                </div>
                                                                <div Style="flex:1;">
                                                                    <MudText Typo="Typo.body2" Class="fw-semibold">@svc.Name</MudText>
                                                                    @if (!string.IsNullOrEmpty(svc.Description))
                                                                    {
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@svc.Description</MudText>
                                                                    }
                                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@svc.DurationMinutes min</MudText>
                                                                </div>
                                                                <MudText Typo="Typo.body2" Class="fw-bold" Style="color:var(--mud-palette-primary);white-space:nowrap;">
                                                                    @svc.Price.ToString("C2")
                                                                </MudText>
                                                            </div>
                                                        }
                                                    }
                                                </MudPaper>
                                            </MudStack>
                                            break;
                                        default:
                                            <MudTextField Label="@f.Label" Variant="Variant.Outlined"
                                                          Placeholder="@f.Placeholder" Required="@f.IsRequired"
                                                          Value="@GetFieldValue(f.FieldName)"
                                                          ValueChanged="@((string v) => SetFieldValue(f.FieldName, v))" />
                                            break;
                                    }
                                </MudItem>
                            }
                        }

                        <!-- Payment method -->
                        @if (_tenant.AllowPayAtShop || _tenant.AllowPayInCash)
                        {
                            <MudItem xs="12">
                                <MudDivider Class="my-1" />
                                <MudText Typo="Typo.subtitle2" Class="fw-semibold mb-2">Payment Method</MudText>
                                <MudRadioGroup T="string" @bind-Value="_paymentMethodChoice">
                                    @if (_tenant.EnableStripe || _tenant.EnablePayPal)
                                    {
                                        <MudRadio T="string" Value="@("online")">Pay online (card / PayPal)</MudRadio>
                                    }
                                    @if (_tenant.AllowPayAtShop)
                                    {
                                        <MudRadio T="string" Value="@("shop")">Pay at the shop / reception</MudRadio>
                                    }
                                    @if (_tenant.AllowPayInCash)
                                    {
                                        <MudRadio T="string" Value="@("cash")">Pay in cash</MudRadio>
                                    }
                                </MudRadioGroup>
                            </MudItem>
                        }
                    </MudGrid>
                </MudForm>

                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" OnClick="@(() => _step = 2)"
                               StartIcon="@Icons.Material.Filled.ArrowBack">Back</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => _step = 4)"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               Disabled="@(string.IsNullOrWhiteSpace(_customerName) || string.IsNullOrWhiteSpace(_customerEmail))">
                        Review & Confirm
                    </MudButton>
                </MudStack>
            }

            <!-- Step 4: Review & confirm -->
            @if (_step == 4)
            {
                <MudText Typo="Typo.h6" Class="fw-bold mb-3">Review & Confirm</MudText>

                <div class="confirm-card">
                    <div class="confirm-header">
                        <MudText Typo="Typo.h6" Style="color:#fff;font-weight:700;">@_selectedService?.Name</MudText>
                        <MudText Style="color:rgba(255,255,255,.8);">@_selectedSlot?.ToString("dddd d MMMM yyyy, h:mm tt")</MudText>
                    </div>
                    <MudCardContent>
                        <MudGrid Spacing="2">
                            <MudItem xs="6">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Name</MudText>
                                <MudText Class="fw-medium">@_customerName</MudText>
                            </MudItem>
                            <MudItem xs="6">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                                <MudText Class="fw-medium">@_customerEmail</MudText>
                            </MudItem>
                            @if (!string.IsNullOrEmpty(_customerPhone))
                            {
                                <MudItem xs="6">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Phone</MudText>
                                    <MudText Class="fw-medium">@_customerPhone</MudText>
                                </MudItem>
                            }
                            <MudItem xs="6">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Duration</MudText>
                                <MudText Class="fw-medium">@_requestedDurationMinutes min@(IsCustomDuration ? " (custom)" : "")</MudText>
                            </MudItem>
                            @if (_selectedService != null && _selectedService.Price > 0)
                            {
                                <MudItem xs="12">
                                    <MudDivider />
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Service price</MudText>
                                    <MudText Class="fw-medium">@CurrencySymbol()@_selectedService.Price.ToString("0.00")</MudText>
                                </MudItem>
                                @if (_tenant.VatRate > 0)
                                {
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">VAT (@_tenant.VatRate%)</MudText>
                                        <MudText Class="fw-medium">@CurrencySymbol()@((_selectedService.Price * _tenant.VatRate / 100).ToString("0.00"))</MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Class="fw-bold">Total</MudText>
                                            <MudText Class="fw-bold" Color="Color.Primary">
                                                @CurrencySymbol()@((_selectedService.Price * (1 + _tenant.VatRate / 100)).ToString("0.00"))
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                }
                            }
                            @if (!string.IsNullOrEmpty(_paymentMethodChoice))
                            {
                                <MudItem xs="12">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Payment</MudText>
                                    <MudText Class="fw-medium">@PaymentMethodLabel(_paymentMethodChoice)</MudText>
                                </MudItem>
                            }
                            @if (_cvFileName != null)
                            {
                                <MudItem xs="12">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">CV</MudText>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Class="fw-medium">@_cvFileName</MudText>
                                    </MudStack>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudCardContent>
                </div>

                @if (!string.IsNullOrEmpty(_bookingError))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-3">@_bookingError</MudAlert>
                }

                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" OnClick="@(() => _step = 3)"
                               StartIcon="@Icons.Material.Filled.ArrowBack">Back</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ConfirmBooking"
                               Disabled="_submitting" StartIcon="@Icons.Material.Filled.CheckCircle">
                        @(_submitting ? "Booking…" : "Confirm Booking")
                    </MudButton>
                </MudStack>
            }
        }
    </div>
</div>

@code {
    [Parameter] public string TenantSlug { get; set; } = "";

    private string EffectivePrimaryColor() =>
        !string.IsNullOrEmpty(_tenant?.PrimaryColor)
            ? _tenant.PrimaryColor
            : BookItTheme.PrimaryOf(_tenant?.Theme ?? TenantTheme.Indigo);

    private TenantResponse? _tenant;
    private List<ServiceResponse> _services = new();
    private BookingFormResponse? _bookingForm;
    private bool _loading = true;
    private bool _confirmed;
    private int _step = 1;

    // Step 1
    private ServiceResponse? _selectedService;
    // Step 2
    private DateTime? _pickedDate;
    private List<DateTime> _availableSlots = new();
    private DateTime? _selectedSlot;
    private bool _slotsLoading;
    private int _requestedDurationMinutes;
    // Step 3
    private MudForm? _detailsForm;
    private string _customerName = "";
    private string _customerEmail = "";
    private string _customerPhone = "";
    private string _customerNotes = "";
    private Dictionary<string, string> _customFieldValues = new();
    private string _cvFileName = "";
    private string _cvFileBase64 = "";
    private string _paymentMethodChoice = "online";
    // Step 4
    private bool _submitting;
    private string? _bookingError;
    private AppointmentResponse? _confirmedAppointment;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        _tenant = await Api.GetTenantAsync(TenantSlug);
        if (_tenant != null)
        {
            _services = await Api.GetServicesAsync(TenantSlug) ?? new();
            // Load default booking form if any
            var forms = await Api.GetFormsAsync(TenantSlug);
            _bookingForm = forms?.FirstOrDefault(f => f.IsDefault) ?? forms?.FirstOrDefault();
        }
        _loading = false;
        StateHasChanged();
    }

    private void SelectService(ServiceResponse svc)
    {
        _selectedService = svc;
        _selectedSlot = null;
        _availableSlots.Clear();
        _requestedDurationMinutes = svc.DurationMinutes;
    }

    private async Task OnDateChanged(DateTime? date)
    {
        _pickedDate = date;
        _selectedSlot = null;
        if (date == null || _selectedService == null) return;
        _slotsLoading = true;
        StateHasChanged();
        _availableSlots = await Api.GetAvailableSlotsAsync(TenantSlug, _selectedService.Id, null, DateOnly.FromDateTime(date.Value)) ?? new();
        _slotsLoading = false;
        StateHasChanged();
    }

    private const long MaxCvFileSizeBytes = 5 * 1024 * 1024; // 5 MB

    private void TriggerFileInput() => Js.InvokeVoidAsync("eval", "document.getElementById('cvFileInput').click()");

    private async Task OnCvFileChanged(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        _cvFileName = file.Name;
        using var ms = new System.IO.MemoryStream();
        await file.OpenReadStream(maxAllowedSize: MaxCvFileSizeBytes).CopyToAsync(ms);
        _cvFileBase64 = Convert.ToBase64String(ms.ToArray());
        StateHasChanged();
    }

    private string GetFieldValue(string key) =>
        _customFieldValues.TryGetValue(key, out var v) ? v : "";

    private void SetFieldValue(string key, string value) =>
        _customFieldValues[key] = value;

    private bool IsCheckboxChecked(string key, string option)
    {
        if (!_customFieldValues.TryGetValue(key, out var v)) return false;
        return v.Split(',').Select(s => s.Trim()).Contains(option);
    }

    private void ToggleCheckbox(string key, string option, bool isChecked)
    {
        var current = _customFieldValues.TryGetValue(key, out var v)
            ? v.Split(',').Select(s => s.Trim()).Where(s => s.Length > 0).ToList()
            : new List<string>();
        if (isChecked && !current.Contains(option)) current.Add(option);
        else if (!isChecked) current.Remove(option);
        _customFieldValues[key] = string.Join(", ", current);
    }

    private static PaymentMethod ParsePaymentMethod(string choice) => choice switch
    {
        "shop" => PaymentMethod.PayAtShop,
        "cash" => PaymentMethod.Cash,
        _      => PaymentMethod.Online,
    };

    private async Task ConfirmBooking()
    {
        if (_selectedService == null || !_selectedSlot.HasValue) return;
        _submitting = true;
        _bookingError = null;

        var formDataJson = _customFieldValues.Any()
            ? System.Text.Json.JsonSerializer.Serialize(_customFieldValues)
            : null;

        var req = new CreateAppointmentRequest
        {
            ServiceId = _selectedService.Id,
            StartTime = _selectedSlot.Value,
            CustomerName = _customerName,
            CustomerEmail = _customerEmail,
            CustomerPhone = string.IsNullOrWhiteSpace(_customerPhone) ? null : _customerPhone,
            CustomerNotes = IsCustomDuration
                ? $"[Requested duration: {_requestedDurationMinutes} min] {_customerNotes}".Trim()
                : (string.IsNullOrWhiteSpace(_customerNotes) ? null : _customerNotes),
            CustomFormDataJson = formDataJson,
            CvFileBase64 = string.IsNullOrEmpty(_cvFileBase64) ? null : _cvFileBase64,
            CvFileName = string.IsNullOrEmpty(_cvFileName) ? null : _cvFileName,
            PaymentMethodChoice = ParsePaymentMethod(_paymentMethodChoice),
        };

        var result = await Api.CreateAppointmentAsync(TenantSlug, req);
        _submitting = false;
        if (result != null)
        {
            _confirmedAppointment = result;
            _confirmed = true;
        }
        else
        {
            _bookingError = "Booking failed — please check your details and try again.";
        }
        StateHasChanged();
    }

    private string StepClass(int s)
    {
        if (_step > s) return "done";
        if (_step == s) return "active";
        return "";
    }

    private string CurrencySymbol() => _tenant?.Currency switch
    {
        "USD" => "$", "EUR" => "€", "AUD" => "A$", "CAD" => "C$",
        "NZD" => "NZ$", "SGD" => "S$", "CHF" => "Fr", "JPY" => "¥",
        "ZAR" => "R", _ => "£"
    };

    private static string PaymentMethodLabel(string? m) => m switch
    {
        "shop" => "Pay at shop / reception",
        "cash" => "Pay in cash",
        _ => "Pay online"
    };

    private bool IsCustomDuration =>
        _requestedDurationMinutes != (_selectedService?.DurationMinutes ?? 0) &&
        _requestedDurationMinutes > 0;

    private List<int> DurationOptions()
    {
        var baseDur = _selectedService?.DurationMinutes ?? 30;
        // Offer base duration plus 30-min increments up to 3× the base or 180 min max
        var opts = new List<int> { baseDur };
        for (var next = baseDur + 30; next <= Math.Min(baseDur * 3, 180); next += 30)
            opts.Add(next);
        return opts;
    }

    private void SetDuration(int minutes)
    {
        _requestedDurationMinutes = minutes;
        _selectedSlot = null; // reset slot when duration changes
    }
}
