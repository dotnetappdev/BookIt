@page "/listings"
@rendermode InteractiveServer
@inject BookItApiService Api
@inject NavigationManager Nav

<PageTitle>Property Listings ‚Äî BookIt</PageTitle>

<style>
    .listings-hero {
        background: linear-gradient(140deg, #07071a 0%, #0f0f2e 40%, #1e1050 100%);
        padding: 4rem 1.5rem 3rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .listings-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: linear-gradient(rgba(108,92,231,.06) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(108,92,231,.06) 1px, transparent 1px);
        background-size: 48px 48px;
        pointer-events: none;
    }
    .filter-bar {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
    }
    .listing-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 14px;
        overflow: hidden;
        transition: box-shadow .2s, transform .15s;
        height: 100%;
    }
    .listing-card:hover {
        box-shadow: 0 8px 32px rgba(108,92,231,.18);
        transform: translateY(-2px);
    }
    .listing-img {
        width: 100%; height: 200px; object-fit: cover;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex; align-items: center; justify-content: center;
        color: rgba(255,255,255,.2); font-size: 3rem;
    }
    .listing-badge {
        display: inline-flex; align-items: center; gap: 4px;
        font-size: .7rem; font-weight: 700; padding: .2rem .55rem;
        border-radius: 99px; text-transform: uppercase; letter-spacing: .05em;
    }
    .price-tag {
        font-size: 1.5rem; font-weight: 800;
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .amenity-pill {
        display: inline-flex; align-items: center; gap: 4px;
        font-size: .72rem; padding: .18rem .5rem;
        border-radius: 99px;
        background: rgba(108,92,231,.1); color: #a29bfe;
        border: 1px solid rgba(108,92,231,.2);
        white-space: nowrap;
    }
    .view-toggle {
        display: flex; gap: 4px;
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 10px; padding: 4px;
    }
    .view-toggle button {
        border: none; background: transparent; border-radius: 8px;
        padding: 6px 12px; cursor: pointer; color: var(--mud-palette-text-secondary);
        transition: .15s;
    }
    .view-toggle button.active {
        background: rgba(108,92,231,.15); color: #a29bfe;
    }
    .list-row {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 12px; padding: 1.25rem;
        display: flex; gap: 1.25rem; align-items: flex-start;
        transition: box-shadow .2s;
        margin-bottom: .75rem;
    }
    .list-row:hover { box-shadow: 0 4px 20px rgba(108,92,231,.14); }
    .list-row-img {
        width: 120px; height: 90px; border-radius: 10px; object-fit: cover; flex-shrink: 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex; align-items: center; justify-content: center;
        color: rgba(255,255,255,.2); font-size: 1.5rem;
    }
</style>

<!-- Hero -->
<div class="listings-hero">
    <div style="position:relative;z-index:1;">
        <div style="display:inline-flex;align-items:center;gap:.5rem;background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);border-radius:99px;padding:.3rem .875rem;font-size:.8rem;font-weight:600;color:#a29bfe;margin-bottom:1.25rem;">
            <MudIcon Icon="@Icons.Material.Filled.Hotel" Size="Size.Small" /> Hotels &amp; B&amp;Bs
        </div>
        <h1 style="color:white;font-weight:800;font-size:clamp(1.75rem,5vw,2.75rem);letter-spacing:-.04em;margin:0 0 .75rem;">
            Find Your Perfect Stay
        </h1>
        <p style="color:rgba(255,255,255,.55);font-size:1rem;max-width:480px;margin:0 auto 2rem;line-height:1.7;">
            Browse hotels and bed &amp; breakfasts. Book directly with instant confirmation.
        </p>
        <!-- Quick search bar -->
        <div style="max-width:600px;margin:0 auto;display:flex;gap:.75rem;flex-wrap:wrap;justify-content:center;">
            <MudTextField @bind-Value="_filterCity" Placeholder="City or destination‚Ä¶"
                          Variant="Variant.Outlined" Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.LocationOn"
                          Style="background:rgba(255,255,255,.07);border-radius:10px;flex:1;min-width:200px;"
                          Class="mud-input-outlined-white" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters"
                       StartIcon="@Icons.Material.Filled.Search"
                       Style="border-radius:10px;font-weight:700;padding:.65rem 1.5rem;">
                Search
            </MudButton>
        </div>
    </div>
</div>

<MudContainer MaxWidth="MaxWidth.Large" Style="padding-top:2rem;padding-bottom:4rem;">

    <!-- Filter + sort bar -->
    <div class="filter-bar">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="3">
                <MudNumericField T="decimal?" @bind-Value="_filterMinRate" Label="Min price/night" Variant="Variant.Outlined"
                                 Clearable="true" Format="0" Adornment="Adornment.Start" AdornmentText="¬£" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudNumericField T="decimal?" @bind-Value="_filterMaxRate" Label="Max price/night" Variant="Variant.Outlined"
                                 Clearable="true" Format="0" Adornment="Adornment.Start" AdornmentText="¬£" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect T="string" @bind-Value="_sortBy" Label="Sort by" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("name")">Name (A‚ÄìZ)</MudSelectItem>
                    <MudSelectItem Value="@("price_asc")">Price (low‚Äìhigh)</MudSelectItem>
                    <MudSelectItem Value="@("price_desc")">Price (high‚Äìlow)</MudSelectItem>
                    <MudSelectItem Value="@("rooms_desc")">Most rooms</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="2" Style="display:flex;align-items:center;">
                <MudSwitch @bind-Value="_filterPetFriendly" Label="Pet friendly" Color="Color.Success" />
            </MudItem>
            <MudItem xs="6" sm="2" Style="display:flex;align-items:center;">
                <MudSwitch @bind-Value="_filterWheelchair" Label="Accessible" Color="Color.Info" />
            </MudItem>
        </MudGrid>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-3">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @if (!_loading) { <span>@_listings.Count propert@(_listings.Count == 1 ? "y" : "ies") found</span> }
            </MudText>
            <div style="display:flex;align-items:center;gap:.75rem;">
                <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="ApplyFilters"
                           StartIcon="@Icons.Material.Filled.FilterList">Apply</MudButton>
                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ClearFilters">Clear</MudButton>
                <div class="view-toggle">
                    <button class="@(_viewMode == "grid" ? "active" : "")" @onclick="@(() => _viewMode = "grid")" title="Grid view">
                        <MudIcon Icon="@Icons.Material.Filled.GridView" Size="Size.Small" />
                    </button>
                    <button class="@(_viewMode == "list" ? "active" : "")" @onclick="@(() => _viewMode = "list")" title="List view">
                        <MudIcon Icon="@Icons.Material.Filled.ViewList" Size="Size.Small" />
                    </button>
                </div>
            </div>
        </MudStack>
    </div>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
        <MudGrid Spacing="3">
            @for (int i = 0; i < 6; i++)
            {
                <MudItem xs="12" sm="6" lg="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="320px" Style="border-radius:14px;" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (!_listings.Any())
    {
        <div style="text-align:center;padding:5rem 2rem;">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Style="opacity:.3;" />
            <MudText Typo="Typo.h6" Class="mt-3">No properties found</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">Try adjusting your filters or search a different city.</MudText>
            <MudButton Variant="Variant.Outlined" Class="mt-3" OnClick="ClearFilters">Clear Filters</MudButton>
        </div>
    }
    else if (_viewMode == "grid")
    {
        <!-- Grid view -->
        <MudGrid Spacing="3">
            @foreach (var listing in _listings)
            {
                var cheapestRoom = listing.Rooms.OrderBy(r => r.BaseRate).FirstOrDefault();
                var coverUrl = listing.Rooms.SelectMany(r => new[] { r.PrimaryPhotoUrl }).FirstOrDefault(u => !string.IsNullOrEmpty(u));
                <MudItem xs="12" sm="6" lg="4">
                    <div class="listing-card">
                        @if (!string.IsNullOrEmpty(coverUrl))
                        {
                            <img src="@coverUrl" alt="@listing.TenantName" class="listing-img" loading="lazy" />
                        }
                        else
                        {
                            <div class="listing-img">
                                <MudIcon Icon="@Icons.Material.Filled.Hotel" />
                            </div>
                        }
                        <div style="padding:1.25rem;">
                            <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                                <div>
                                    <MudText Typo="Typo.h6" Class="fw-bold" Style="line-height:1.2;">@listing.TenantName</MudText>
                                    @if (!string.IsNullOrEmpty(listing.City))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Style="vertical-align:middle;" />
                                            @listing.City@(!string.IsNullOrEmpty(listing.Country) ? $", {listing.Country}" : "")
                                        </MudText>
                                    }
                                </div>
                                @if (listing.MinRate > 0)
                                {
                                    <div style="text-align:right;flex-shrink:0;">
                                        <div class="price-tag">¬£@listing.MinRate.ToString("0")</div>
                                        <div style="font-size:.7rem;color:var(--mud-palette-text-secondary);">per night</div>
                                    </div>
                                }
                            </MudStack>

                            @if (!string.IsNullOrEmpty(listing.Description))
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2"
                                         Style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                                    @listing.Description
                                </MudText>
                            }

                            <!-- Room summary badges -->
                            <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" Class="mt-2">
                                <span class="listing-badge" style="background:rgba(108,92,231,.1);color:#a29bfe;border:1px solid rgba(108,92,231,.2);">
                                    <MudIcon Icon="@Icons.Material.Filled.MeetingRoom" Size="Size.Small" /> @listing.RoomCount room@(listing.RoomCount != 1 ? "s" : "")
                                </span>
                                @if (listing.Rooms.Any(r => r.PetFriendly))
                                {
                                    <span class="listing-badge" style="background:rgba(16,185,129,.1);color:#10b981;border:1px solid rgba(16,185,129,.2);">üêæ Pets OK</span>
                                }
                                @if (listing.Rooms.Any(r => r.WheelchairAccessible))
                                {
                                    <span class="listing-badge" style="background:rgba(59,130,246,.1);color:#60a5fa;border:1px solid rgba(59,130,246,.2);">‚ôø Accessible</span>
                                }
                            </MudStack>

                            <!-- Amenities -->
                            @if (listing.AmenityNames.Any())
                            {
                                <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:.625rem;">
                                    @foreach (var name in listing.AmenityNames.Take(5))
                                    {
                                        <span class="amenity-pill">@name</span>
                                    }
                                    @if (listing.AmenityNames.Count > 5)
                                    {
                                        <span class="amenity-pill">+@(listing.AmenityNames.Count - 5) more</span>
                                    }
                                </div>
                            }

                            <!-- CTA -->
                            <MudStack Row="true" Spacing="2" Class="mt-3">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                           Href="@($"/{listing.TenantSlug}/book")"
                                           StartIcon="@Icons.Material.Filled.BookOnline">
                                    Book Now
                                </MudButton>
                            </MudStack>
                        </div>
                    </div>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <!-- List view -->
        <div>
            @foreach (var listing in _listings)
            {
                var coverUrl = listing.Rooms.SelectMany(r => new[] { r.PrimaryPhotoUrl }).FirstOrDefault(u => !string.IsNullOrEmpty(u));
                <div class="list-row">
                    @if (!string.IsNullOrEmpty(coverUrl))
                    {
                        <img src="@coverUrl" alt="@listing.TenantName" class="list-row-img" loading="lazy" />
                    }
                    else
                    {
                        <div class="list-row-img">
                            <MudIcon Icon="@Icons.Material.Filled.Hotel" />
                        </div>
                    }
                    <div style="flex:1;min-width:0;">
                        <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween" Wrap="Wrap.Wrap">
                            <div>
                                <MudText Typo="Typo.h6" Class="fw-bold">@listing.TenantName</MudText>
                                @if (!string.IsNullOrEmpty(listing.City))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Style="vertical-align:middle;" />
                                        @listing.City@(!string.IsNullOrEmpty(listing.Country) ? $", {listing.Country}" : "")
                                    </MudText>
                                }
                                @if (!string.IsNullOrEmpty(listing.Description))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1"
                                             Style="display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;">
                                        @listing.Description
                                    </MudText>
                                }
                            </div>
                            <div style="text-align:right;flex-shrink:0;">
                                @if (listing.MinRate > 0)
                                {
                                    <div class="price-tag">¬£@listing.MinRate.ToString("0")</div>
                                    <div style="font-size:.7rem;color:var(--mud-palette-text-secondary);">per night</div>
                                }
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                           Href="@($"/{listing.TenantSlug}/book")" Class="mt-1">
                                    Book Now
                                </MudButton>
                            </div>
                        </MudStack>
                        <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" Class="mt-2">
                            <span class="listing-badge" style="background:rgba(108,92,231,.1);color:#a29bfe;border:1px solid rgba(108,92,231,.2);">
                                @listing.RoomCount room@(listing.RoomCount != 1 ? "s" : "")
                            </span>
                            @if (listing.Rooms.Any(r => r.PetFriendly))
                            {
                                <span class="listing-badge" style="background:rgba(16,185,129,.1);color:#10b981;border:1px solid rgba(16,185,129,.2);">üêæ Pets OK</span>
                            }
                            @if (listing.Rooms.Any(r => r.WheelchairAccessible))
                            {
                                <span class="listing-badge" style="background:rgba(59,130,246,.1);color:#60a5fa;border:1px solid rgba(59,130,246,.2);">‚ôø Accessible</span>
                            }
                            @foreach (var name in listing.AmenityNames.Take(4))
                            {
                                <span class="amenity-pill">@name</span>
                            }
                        </MudStack>
                    </div>
                </div>
            }
        </div>
    }
</MudContainer>

@code {
    private List<PublicPropertyListingResponse> _listings = new();
    private bool _loading = true;
    private string _viewMode = "grid";

    // Filters
    private string? _filterCity;
    private decimal? _filterMinRate;
    private decimal? _filterMaxRate;
    private bool _filterPetFriendly = false;
    private bool _filterWheelchair = false;
    private string _sortBy = "name";

    protected override async Task OnInitializedAsync()
    {
        await LoadListingsAsync();
    }

    private async Task LoadListingsAsync()
    {
        _loading = true;
        var results = await Api.GetPublicListingsAsync(
            city: _filterCity,
            minRate: _filterMinRate,
            maxRate: _filterMaxRate,
            petFriendly: _filterPetFriendly ? true : null,
            wheelchairAccessible: _filterWheelchair ? true : null,
            sortBy: _sortBy);
        _listings = results ?? new();
        _loading = false;
    }

    private async Task ApplyFilters() => await LoadListingsAsync();

    private async Task ClearFilters()
    {
        _filterCity = null;
        _filterMinRate = null;
        _filterMaxRate = null;
        _filterPetFriendly = false;
        _filterWheelchair = false;
        _sortBy = "name";
        await LoadListingsAsync();
    }
}
